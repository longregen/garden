<style>
/* Contacts Page Specific Styles */
.contacts-page {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
}

/* Statistics Panel */
.stats-panel {
    background: var(--color-background-elevated);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    transition: max-height var(--transition-slow);
}

.stats-panel.collapsed .stats-content {
    display: none;
}

.stats-panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-4);
    cursor: pointer;
    user-select: none;
}

.stats-panel-header:hover {
    background: var(--color-background-hover);
}

.stats-panel-title {
    font-weight: var(--font-weight-semibold);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.stats-toggle-icon {
    transition: transform var(--transition-base);
}

.stats-panel.collapsed .stats-toggle-icon {
    transform: rotate(-90deg);
}

.stats-content {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-4);
    padding: 0 var(--space-4) var(--space-4);
}

.stat-item {
    text-align: center;
    padding: var(--space-3);
    background: var(--color-background);
    border-radius: var(--radius-md);
}

.stat-value {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-accent);
}

.stat-label {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
}

.stat-breakdown {
    padding: var(--space-3);
    background: var(--color-background);
    border-radius: var(--radius-md);
}

.stat-breakdown-title {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    margin-bottom: var(--space-2);
    color: var(--color-text-secondary);
}

.stat-breakdown-bars {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
}

.stat-bar-item {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--font-size-xs);
}

.stat-bar-label {
    width: 80px;
    color: var(--color-text-secondary);
}

.stat-bar-track {
    flex: 1;
    height: 8px;
    background: var(--color-background-active);
    border-radius: var(--radius-full);
    overflow: hidden;
}

.stat-bar-fill {
    height: 100%;
    background: var(--color-accent);
    border-radius: var(--radius-full);
    transition: width var(--transition-base);
}

.stat-bar-count {
    width: 30px;
    text-align: right;
    color: var(--color-text-muted);
}

/* Controls Bar */
.contacts-controls {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-3);
    align-items: center;
    padding: var(--space-3);
    background: var(--color-background-elevated);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
}

.contacts-search {
    flex: 1;
    min-width: 250px;
    position: relative;
}

.contacts-search-icon {
    position: absolute;
    left: var(--space-3);
    top: 50%;
    transform: translateY(-50%);
    color: var(--color-text-tertiary);
    pointer-events: none;
}

.contacts-search-input {
    width: 100%;
    padding: var(--space-2) var(--space-3) var(--space-2) var(--space-10);
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text-primary);
    font-size: var(--font-size-sm);
}

.contacts-search-input:focus {
    outline: none;
    border-color: var(--color-accent);
    box-shadow: 0 0 0 3px var(--color-accent-light);
}

.filter-group {
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.filter-select {
    padding: var(--space-2) var(--space-8) var(--space-2) var(--space-3);
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text-primary);
    font-size: var(--font-size-sm);
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23888888' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right var(--space-2) center;
}

.filter-select:focus {
    outline: none;
    border-color: var(--color-accent);
}

.view-toggles {
    display: flex;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    overflow: hidden;
}

.view-toggle-btn {
    padding: var(--space-2) var(--space-3);
    background: var(--color-background);
    color: var(--color-text-secondary);
    border: none;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.view-toggle-btn:not(:last-child) {
    border-right: 1px solid var(--color-border);
}

.view-toggle-btn:hover {
    background: var(--color-background-hover);
    color: var(--color-text-primary);
}

.view-toggle-btn.active {
    background: var(--color-accent);
    color: var(--color-text-primary);
}

/* Bulk Actions Bar */
.bulk-actions-bar {
    display: none;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-3) var(--space-4);
    background: var(--color-accent-light);
    border: 1px solid var(--color-accent);
    border-radius: var(--radius-lg);
}

.bulk-actions-bar.visible {
    display: flex;
}

.bulk-count {
    font-weight: var(--font-weight-medium);
    color: var(--color-accent);
}

.bulk-actions {
    display: flex;
    gap: var(--space-2);
    margin-left: auto;
}

/* Contact Cards Grid */
.contacts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: var(--space-4);
}

.contact-card {
    background: var(--color-background-elevated);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
    cursor: pointer;
    transition: all var(--transition-fast);
    position: relative;
}

.contact-card:hover {
    border-color: var(--color-border-focus);
    box-shadow: var(--shadow-md);
}

.contact-card.selected {
    border-color: var(--color-accent);
    background: var(--color-accent-light);
}

.contact-card-checkbox {
    position: absolute;
    top: var(--space-3);
    left: var(--space-3);
    width: 20px;
    height: 20px;
    appearance: none;
    border: 2px solid var(--color-border);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
    opacity: 0;
}

.contact-card:hover .contact-card-checkbox,
.contact-card.selected .contact-card-checkbox {
    opacity: 1;
}

.contact-card-checkbox:checked {
    background: var(--color-accent);
    border-color: var(--color-accent);
    opacity: 1;
}

.contact-card-checkbox:checked::after {
    content: '';
    position: absolute;
    left: 5px;
    top: 1px;
    width: 6px;
    height: 10px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
}

.contact-card-header {
    display: flex;
    align-items: flex-start;
    gap: var(--space-3);
    margin-bottom: var(--space-3);
}

.contact-avatar {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-semibold);
    color: white;
    flex-shrink: 0;
}

.contact-info {
    flex: 1;
    min-width: 0;
}

.contact-name {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    margin-bottom: var(--space-1);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.contact-email {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.contact-aliases {
    font-size: var(--font-size-xs);
    color: var(--color-text-tertiary);
    margin-top: var(--space-1);
}

/* Evaluation Bars */
.evaluation-bars {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    margin: var(--space-3) 0;
}

.eval-bar {
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.eval-label {
    width: 80px;
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
}

.eval-track {
    flex: 1;
    height: 6px;
    background: var(--color-background-active);
    border-radius: var(--radius-full);
    overflow: hidden;
}

.eval-fill {
    height: 100%;
    border-radius: var(--radius-full);
    transition: width var(--transition-base);
}

.eval-fill.importance {
    background: linear-gradient(90deg, #f5a623, #e00000);
}

.eval-fill.closeness {
    background: linear-gradient(90deg, #50e3c2, #0070f3);
}

.eval-fill.fondness {
    background: linear-gradient(90deg, #ff6b9d, #c44569);
}

.eval-value {
    width: 24px;
    font-size: var(--font-size-xs);
    color: var(--color-text-tertiary);
    text-align: right;
}

/* Source Icons */
.contact-sources {
    display: flex;
    gap: var(--space-2);
    margin-bottom: var(--space-2);
}

.source-icon {
    width: 24px;
    height: 24px;
    border-radius: var(--radius-sm);
    background: var(--color-background-active);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text-secondary);
}

.source-icon.active {
    background: var(--color-accent-light);
    color: var(--color-accent);
}

/* Contact Tags */
.contact-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-1);
    margin-bottom: var(--space-3);
}

.contact-tag {
    padding: var(--space-1) var(--space-2);
    background: var(--color-background-active);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
}

/* Quick Actions */
.contact-actions {
    display: flex;
    gap: var(--space-2);
    padding-top: var(--space-3);
    border-top: 1px solid var(--color-border);
}

.contact-action-btn {
    flex: 1;
    padding: var(--space-2);
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text-secondary);
    font-size: var(--font-size-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-1);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.contact-action-btn:hover {
    background: var(--color-background-hover);
    border-color: var(--color-border-focus);
    color: var(--color-text-primary);
}

/* Table View */
.contacts-table-container {
    display: none;
    overflow-x: auto;
}

.contacts-table-container.active {
    display: block;
}

.contacts-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--color-background-elevated);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    overflow: hidden;
}

.contacts-table th,
.contacts-table td {
    padding: var(--space-3) var(--space-4);
    text-align: left;
    border-bottom: 1px solid var(--color-border);
}

.contacts-table th {
    background: var(--color-background-secondary);
    font-weight: var(--font-weight-medium);
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    cursor: pointer;
    user-select: none;
}

.contacts-table th:hover {
    background: var(--color-background-hover);
}

.contacts-table th .sort-icon {
    margin-left: var(--space-1);
    opacity: 0.5;
}

.contacts-table th.sorted .sort-icon {
    opacity: 1;
}

.contacts-table tbody tr {
    cursor: pointer;
    transition: background var(--transition-fast);
}

.contacts-table tbody tr:hover {
    background: var(--color-background-hover);
}

.contacts-table tbody tr.selected {
    background: var(--color-accent-light);
}

.contacts-table .checkbox-cell {
    width: 40px;
}

.table-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: white;
}

.table-name-cell {
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.table-eval-mini {
    display: flex;
    gap: 2px;
}

.eval-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--color-background-active);
}

.eval-dot.filled {
    background: var(--color-accent);
}

/* Compact List View */
.contacts-compact {
    display: none;
    flex-direction: column;
    background: var(--color-background-elevated);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    overflow: hidden;
}

.contacts-compact.active {
    display: flex;
}

.compact-item {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-3) var(--space-4);
    border-bottom: 1px solid var(--color-border);
    cursor: pointer;
    transition: background var(--transition-fast);
}

.compact-item:last-child {
    border-bottom: none;
}

.compact-item:hover {
    background: var(--color-background-hover);
}

.compact-item.selected {
    background: var(--color-accent-light);
}

.compact-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: white;
}

.compact-info {
    flex: 1;
    min-width: 0;
}

.compact-name {
    font-weight: var(--font-weight-medium);
}

.compact-email {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
}

.compact-meta {
    display: flex;
    align-items: center;
    gap: var(--space-4);
}

/* Detail Panel */
.detail-panel-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    z-index: 200;
    opacity: 0;
    visibility: hidden;
    transition: all var(--transition-base);
}

.detail-panel-overlay.active {
    opacity: 1;
    visibility: visible;
}

.detail-panel {
    position: fixed;
    top: 0;
    right: 0;
    width: 480px;
    max-width: 100%;
    height: 100vh;
    background: var(--color-background-elevated);
    border-left: 1px solid var(--color-border);
    z-index: 201;
    transform: translateX(100%);
    transition: transform var(--transition-base);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.detail-panel-overlay.active .detail-panel {
    transform: translateX(0);
}

.detail-panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-4);
    border-bottom: 1px solid var(--color-border);
    background: var(--color-background);
}

.detail-panel-title {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
}

.detail-panel-close {
    padding: var(--space-2);
    border-radius: var(--radius-md);
    color: var(--color-text-secondary);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.detail-panel-close:hover {
    background: var(--color-background-hover);
    color: var(--color-text-primary);
}

.detail-panel-content {
    flex: 1;
    overflow-y: auto;
    padding: var(--space-4);
}

.detail-avatar-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: var(--space-6) 0;
    border-bottom: 1px solid var(--color-border);
    margin-bottom: var(--space-4);
}

.detail-avatar {
    width: 96px;
    height: 96px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--font-size-4xl);
    font-weight: var(--font-weight-semibold);
    color: white;
    margin-bottom: var(--space-3);
    position: relative;
}

.detail-avatar-edit {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 32px;
    height: 32px;
    background: var(--color-background);
    border: 2px solid var(--color-border);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: var(--color-text-secondary);
    transition: all var(--transition-fast);
}

.detail-avatar-edit:hover {
    background: var(--color-background-hover);
    color: var(--color-text-primary);
}

.detail-name {
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-semibold);
    margin-bottom: var(--space-1);
}

.detail-aliases {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
}

.detail-section {
    margin-bottom: var(--space-6);
}

.detail-section-title {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-3);
}

/* Evaluation Sliders */
.eval-slider-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
}

.eval-slider-item {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.eval-slider-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.eval-slider-label {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
}

.eval-slider-value {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
}

.eval-slider {
    -webkit-appearance: none;
    width: 100%;
    height: 8px;
    border-radius: var(--radius-full);
    background: var(--color-background-active);
    outline: none;
    cursor: pointer;
}

.eval-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--color-accent);
    cursor: pointer;
    transition: transform var(--transition-fast);
}

.eval-slider::-webkit-slider-thumb:hover {
    transform: scale(1.1);
}

.eval-slider.importance::-webkit-slider-thumb {
    background: #f5a623;
}

.eval-slider.closeness::-webkit-slider-thumb {
    background: #0070f3;
}

.eval-slider.fondness::-webkit-slider-thumb {
    background: #ff6b9d;
}

/* Detail Info Items */
.detail-info-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
}

.detail-info-item {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-2) 0;
}

.detail-info-icon {
    color: var(--color-text-tertiary);
}

.detail-info-content {
    flex: 1;
}

.detail-info-label {
    font-size: var(--font-size-xs);
    color: var(--color-text-tertiary);
}

.detail-info-value {
    color: var(--color-text-primary);
}

.detail-info-value a {
    color: var(--color-accent);
}

/* Detail Tags */
.detail-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
}

.detail-tag {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-1) var(--space-2);
    background: var(--color-background-active);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
}

.detail-tag-remove {
    cursor: pointer;
    color: var(--color-text-tertiary);
    transition: color var(--transition-fast);
}

.detail-tag-remove:hover {
    color: var(--color-error);
}

.add-tag-btn {
    padding: var(--space-1) var(--space-2);
    background: transparent;
    border: 1px dashed var(--color-border);
    border-radius: var(--radius-sm);
    color: var(--color-text-secondary);
    font-size: var(--font-size-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.add-tag-btn:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
}

/* Rooms List */
.rooms-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.room-item {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-2) var(--space-3);
    background: var(--color-background);
    border-radius: var(--radius-md);
}

.room-icon {
    color: var(--color-text-tertiary);
}

.room-name {
    flex: 1;
    font-size: var(--font-size-sm);
}

.room-count {
    font-size: var(--font-size-xs);
    color: var(--color-text-tertiary);
}

/* Recent Messages */
.recent-messages {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
}

.recent-message {
    padding: var(--space-3);
    background: var(--color-background);
    border-radius: var(--radius-md);
}

.recent-message-content {
    font-size: var(--font-size-sm);
    margin-bottom: var(--space-1);
}

.recent-message-time {
    font-size: var(--font-size-xs);
    color: var(--color-text-tertiary);
}

/* Notes Section */
.contact-notes {
    width: 100%;
    min-height: 100px;
    padding: var(--space-3);
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text-primary);
    font-size: var(--font-size-sm);
    resize: vertical;
}

.contact-notes:focus {
    outline: none;
    border-color: var(--color-accent);
}

/* Activity Timeline */
.activity-timeline {
    position: relative;
    padding-left: var(--space-6);
}

.activity-timeline::before {
    content: '';
    position: absolute;
    left: 8px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: var(--color-border);
}

.timeline-item {
    position: relative;
    padding-bottom: var(--space-4);
}

.timeline-item:last-child {
    padding-bottom: 0;
}

.timeline-dot {
    position: absolute;
    left: calc(-1 * var(--space-6) + 4px);
    top: 4px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--color-accent);
    border: 2px solid var(--color-background-elevated);
}

.timeline-content {
    font-size: var(--font-size-sm);
}

.timeline-time {
    font-size: var(--font-size-xs);
    color: var(--color-text-tertiary);
    margin-top: var(--space-1);
}

/* Detail Panel Footer */
.detail-panel-footer {
    display: flex;
    gap: var(--space-3);
    padding: var(--space-4);
    border-top: 1px solid var(--color-border);
    background: var(--color-background);
}

/* Add/Edit Modal */
.modal-form {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
}

.modal-form-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.modal-form-label {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-secondary);
}

.modal-form-input {
    padding: var(--space-3);
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text-primary);
    font-size: var(--font-size-base);
}

.modal-form-input:focus {
    outline: none;
    border-color: var(--color-accent);
}

.known-names-list {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
}

.known-name-item {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-1) var(--space-2);
    background: var(--color-background-active);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
}

.known-name-remove {
    cursor: pointer;
    color: var(--color-text-tertiary);
}

.known-name-remove:hover {
    color: var(--color-error);
}

.add-known-name {
    display: flex;
    gap: var(--space-2);
}

.add-known-name input {
    flex: 1;
    padding: var(--space-2);
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text-primary);
    font-size: var(--font-size-sm);
}

.sources-editor {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.source-item-edit {
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.source-item-edit select {
    padding: var(--space-2);
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text-primary);
}

.source-item-edit input {
    flex: 1;
    padding: var(--space-2);
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text-primary);
}

/* Responsive */
@media (max-width: 768px) {
    .stats-content {
        grid-template-columns: repeat(2, 1fr);
    }

    .contacts-grid {
        grid-template-columns: 1fr;
    }

    .detail-panel {
        width: 100%;
    }

    .contacts-controls {
        flex-direction: column;
        align-items: stretch;
    }

    .contacts-search {
        min-width: 100%;
    }

    .filter-group {
        flex-wrap: wrap;
    }
}
</style>

<div class="page-header">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="page-title">Contacts</h1>
            <p class="page-description">Manage your personal and professional network</p>
        </div>
        <button class="btn btn-primary" id="add-contact-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            Add Contact
        </button>
    </div>
</div>

<div class="contacts-page">
    <!-- Statistics Panel -->
    <div class="stats-panel" id="stats-panel">
        <div class="stats-panel-header" id="stats-toggle">
            <span class="stats-panel-title">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 20V10M12 20V4M6 20v-6"/>
                </svg>
                Statistics
            </span>
            <svg class="stats-toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="stats-content" id="stats-content">
            <div class="stat-item">
                <div class="stat-value" id="stat-total">0</div>
                <div class="stat-label">Total Contacts</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-active">0</div>
                <div class="stat-label">Active This Week</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-high-importance">0</div>
                <div class="stat-label">High Importance</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-tags">0</div>
                <div class="stat-label">Unique Tags</div>
            </div>
            <div class="stat-breakdown">
                <div class="stat-breakdown-title">Importance Distribution</div>
                <div class="stat-breakdown-bars" id="importance-breakdown"></div>
            </div>
            <div class="stat-breakdown">
                <div class="stat-breakdown-title">Top Tags</div>
                <div class="stat-breakdown-bars" id="tags-breakdown"></div>
            </div>
            <div class="stat-breakdown">
                <div class="stat-breakdown-title">Sources</div>
                <div class="stat-breakdown-bars" id="sources-breakdown"></div>
            </div>
            <div class="stat-breakdown">
                <div class="stat-breakdown-title">Activity</div>
                <div class="stat-breakdown-bars" id="activity-breakdown"></div>
            </div>
        </div>
    </div>

    <!-- Controls Bar -->
    <div class="contacts-controls">
        <div class="contacts-search">
            <svg class="contacts-search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
            <input type="text" class="contacts-search-input" placeholder="Search contacts..." id="contacts-search">
        </div>
        <div class="filter-group">
            <select class="filter-select" id="filter-tag">
                <option value="">All Tags</option>
            </select>
            <select class="filter-select" id="filter-importance">
                <option value="">All Importance</option>
                <option value="9-10">Very High (9-10)</option>
                <option value="7-8">High (7-8)</option>
                <option value="5-6">Medium (5-6)</option>
                <option value="3-4">Low (3-4)</option>
                <option value="1-2">Very Low (1-2)</option>
            </select>
            <select class="filter-select" id="filter-source">
                <option value="">All Sources</option>
                <option value="email">Email</option>
                <option value="matrix">Matrix</option>
                <option value="telegram">Telegram</option>
                <option value="phone">Phone</option>
            </select>
            <select class="filter-select" id="sort-by">
                <option value="name">Sort: Name</option>
                <option value="importance">Sort: Importance</option>
                <option value="closeness">Sort: Closeness</option>
                <option value="fondness">Sort: Fondness</option>
                <option value="recent">Sort: Recent Activity</option>
                <option value="messages">Sort: Messages</option>
            </select>
        </div>
        <div class="view-toggles">
            <button class="view-toggle-btn active" data-view="cards" title="Card View">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7" rx="1"/>
                    <rect x="14" y="3" width="7" height="7" rx="1"/>
                    <rect x="3" y="14" width="7" height="7" rx="1"/>
                    <rect x="14" y="14" width="7" height="7" rx="1"/>
                </svg>
            </button>
            <button class="view-toggle-btn" data-view="table" title="Table View">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 3h7a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-7m0-18H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h7m0-18v18"/>
                    <path d="M3 9h18M3 15h18"/>
                </svg>
            </button>
            <button class="view-toggle-btn" data-view="compact" title="Compact List">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="8" y1="6" x2="21" y2="6"/>
                    <line x1="8" y1="12" x2="21" y2="12"/>
                    <line x1="8" y1="18" x2="21" y2="18"/>
                    <line x1="3" y1="6" x2="3.01" y2="6"/>
                    <line x1="3" y1="12" x2="3.01" y2="12"/>
                    <line x1="3" y1="18" x2="3.01" y2="18"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Bulk Actions Bar -->
    <div class="bulk-actions-bar" id="bulk-actions">
        <input type="checkbox" id="select-all-checkbox">
        <span class="bulk-count"><span id="selected-count">0</span> selected</span>
        <div class="bulk-actions">
            <button class="btn btn-secondary btn-sm" id="bulk-tag-btn">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/>
                </svg>
                Add Tags
            </button>
            <button class="btn btn-secondary btn-sm" id="bulk-merge-btn">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/>
                </svg>
                Merge
            </button>
            <button class="btn btn-secondary btn-sm" id="bulk-export-btn">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                </svg>
                Export
            </button>
            <button class="btn btn-ghost btn-sm" id="bulk-cancel-btn">Cancel</button>
        </div>
    </div>

    <!-- Contact Views -->
    <div id="contacts-content">
        <!-- Cards View -->
        <div class="contacts-grid" id="contacts-cards"></div>

        <!-- Table View -->
        <div class="contacts-table-container" id="contacts-table-container">
            <table class="contacts-table">
                <thead>
                    <tr>
                        <th class="checkbox-cell"><input type="checkbox" id="table-select-all"></th>
                        <th data-sort="name">Name <span class="sort-icon">&#9650;</span></th>
                        <th data-sort="email">Email <span class="sort-icon">&#9650;</span></th>
                        <th data-sort="importance">Importance <span class="sort-icon">&#9650;</span></th>
                        <th data-sort="closeness">Closeness <span class="sort-icon">&#9650;</span></th>
                        <th data-sort="messages">Messages <span class="sort-icon">&#9650;</span></th>
                        <th>Tags</th>
                    </tr>
                </thead>
                <tbody id="contacts-table-body"></tbody>
            </table>
        </div>

        <!-- Compact List View -->
        <div class="contacts-compact" id="contacts-compact"></div>
    </div>

    <!-- Pagination -->
    <div id="contacts-pagination"></div>
</div>

<!-- Detail Panel -->
<div class="detail-panel-overlay" id="detail-panel-overlay">
    <div class="detail-panel" id="detail-panel">
        <div class="detail-panel-header">
            <span class="detail-panel-title">Contact Details</span>
            <button class="detail-panel-close" id="detail-panel-close">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="detail-panel-content" id="detail-panel-content">
            <!-- Dynamic content -->
        </div>
        <div class="detail-panel-footer">
            <button class="btn btn-secondary" id="detail-edit-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
                Edit
            </button>
            <button class="btn btn-secondary" id="detail-message-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                Message
            </button>
            <button class="btn btn-danger" id="detail-delete-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
                Delete
            </button>
        </div>
    </div>
</div>

<script>
// Contacts Manager
(function() {
    let contacts = [];
    let filteredContacts = [];
    let selectedContacts = new Set();
    let currentView = 'cards';
    let currentSort = 'name';
    let currentSortDir = 'asc';
    let currentPage = 1;
    let pageSize = 20;
    let currentContactId = null;

    // Initialize
    async function init() {
        await loadContacts();
        setupEventListeners();
        renderStatistics();
        renderContacts();
        populateFilters();
    }

    // Load contacts from API
    async function loadContacts() {
        try {
            const result = await window.GardenApp.prototype.api
                ? app.api.getContacts({ page: 1, pageSize: 100 })
                : { data: MockData.contacts };
            contacts = result.data || result;
            filteredContacts = [...contacts];
        } catch (error) {
            console.error('Failed to load contacts:', error);
            contacts = MockData.contacts || [];
            filteredContacts = [...contacts];
        }
    }

    // Setup event listeners
    function setupEventListeners() {
        // Stats toggle
        document.getElementById('stats-toggle').addEventListener('click', () => {
            document.getElementById('stats-panel').classList.toggle('collapsed');
        });

        // Search
        const searchInput = document.getElementById('contacts-search');
        searchInput.addEventListener('input', Utils.debounce(() => {
            filterContacts();
        }, 300));

        // Filters
        ['filter-tag', 'filter-importance', 'filter-source', 'sort-by'].forEach(id => {
            document.getElementById(id).addEventListener('change', filterContacts);
        });

        // View toggles
        document.querySelectorAll('.view-toggle-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentView = btn.dataset.view;
                renderContacts();
            });
        });

        // Add contact button
        document.getElementById('add-contact-btn').addEventListener('click', () => {
            openContactModal();
        });

        // Detail panel close
        document.getElementById('detail-panel-close').addEventListener('click', closeDetailPanel);
        document.getElementById('detail-panel-overlay').addEventListener('click', (e) => {
            if (e.target === document.getElementById('detail-panel-overlay')) {
                closeDetailPanel();
            }
        });

        // Bulk actions
        document.getElementById('bulk-cancel-btn').addEventListener('click', () => {
            selectedContacts.clear();
            updateBulkActions();
            renderContacts();
        });

        document.getElementById('select-all-checkbox').addEventListener('change', (e) => {
            if (e.target.checked) {
                filteredContacts.forEach(c => selectedContacts.add(c.contact_id));
            } else {
                selectedContacts.clear();
            }
            updateBulkActions();
            renderContacts();
        });

        document.getElementById('bulk-tag-btn').addEventListener('click', openBulkTagModal);
        document.getElementById('bulk-export-btn').addEventListener('click', exportSelected);
        document.getElementById('bulk-merge-btn').addEventListener('click', openMergeModal);

        // Detail panel actions
        document.getElementById('detail-edit-btn').addEventListener('click', () => {
            if (currentContactId) {
                const contact = contacts.find(c => c.contact_id === currentContactId);
                if (contact) openContactModal(contact);
            }
        });

        document.getElementById('detail-delete-btn').addEventListener('click', async () => {
            if (currentContactId && confirm('Are you sure you want to delete this contact?')) {
                try {
                    await app.api.deleteContact(currentContactId);
                    contacts = contacts.filter(c => c.contact_id !== currentContactId);
                    filterContacts();
                    closeDetailPanel();
                    app.toast.success('Contact deleted');
                } catch (e) {
                    app.toast.error('Failed to delete contact');
                }
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeDetailPanel();
            }
        });
    }

    // Filter contacts
    function filterContacts() {
        const search = document.getElementById('contacts-search').value.toLowerCase();
        const tagFilter = document.getElementById('filter-tag').value;
        const importanceFilter = document.getElementById('filter-importance').value;
        const sourceFilter = document.getElementById('filter-source').value;
        currentSort = document.getElementById('sort-by').value;

        filteredContacts = contacts.filter(contact => {
            // Search filter
            if (search && !contact.name.toLowerCase().includes(search) &&
                !contact.email?.toLowerCase().includes(search)) {
                return false;
            }

            // Tag filter
            if (tagFilter && !contact.tags?.some(t => t.name === tagFilter)) {
                return false;
            }

            // Importance filter
            if (importanceFilter) {
                const [min, max] = importanceFilter.split('-').map(Number);
                if (contact.importance < min || contact.importance > max) {
                    return false;
                }
            }

            // Source filter
            if (sourceFilter) {
                if (sourceFilter === 'email' && !contact.email) return false;
                if (sourceFilter === 'phone' && !contact.phone) return false;
                // For matrix/telegram, check if they have any messages
            }

            return true;
        });

        // Sort
        sortContacts();

        currentPage = 1;
        renderContacts();
        renderStatistics();
    }

    // Sort contacts
    function sortContacts() {
        filteredContacts.sort((a, b) => {
            let aVal, bVal;
            switch (currentSort) {
                case 'name':
                    return a.name.localeCompare(b.name);
                case 'importance':
                    return (b.importance || 0) - (a.importance || 0);
                case 'closeness':
                    return (b.closeness || 0) - (a.closeness || 0);
                case 'fondness':
                    return (b.fondness || 0) - (a.fondness || 0);
                case 'recent':
                    return new Date(b.last_update) - new Date(a.last_update);
                case 'messages':
                    return (b.last_week_messages || 0) - (a.last_week_messages || 0);
                default:
                    return 0;
            }
        });
    }

    // Populate filter dropdowns
    function populateFilters() {
        const tagSelect = document.getElementById('filter-tag');
        const allTags = new Set();
        contacts.forEach(c => c.tags?.forEach(t => allTags.add(t.name)));

        Array.from(allTags).sort().forEach(tag => {
            const option = document.createElement('option');
            option.value = tag;
            option.textContent = tag;
            tagSelect.appendChild(option);
        });
    }

    // Render statistics
    function renderStatistics() {
        // Basic stats
        document.getElementById('stat-total').textContent = contacts.length;
        document.getElementById('stat-active').textContent = contacts.filter(c => c.last_week_messages > 0).length;
        document.getElementById('stat-high-importance').textContent = contacts.filter(c => c.importance >= 7).length;

        const allTags = new Set();
        contacts.forEach(c => c.tags?.forEach(t => allTags.add(t.name)));
        document.getElementById('stat-tags').textContent = allTags.size;

        // Importance breakdown
        const importanceBreakdown = document.getElementById('importance-breakdown');
        const importanceRanges = [
            { label: 'Very High (9-10)', min: 9, max: 10 },
            { label: 'High (7-8)', min: 7, max: 8 },
            { label: 'Medium (5-6)', min: 5, max: 6 },
            { label: 'Low (3-4)', min: 3, max: 4 },
            { label: 'Very Low (1-2)', min: 1, max: 2 }
        ];

        importanceBreakdown.innerHTML = importanceRanges.map(range => {
            const count = contacts.filter(c => c.importance >= range.min && c.importance <= range.max).length;
            const pct = contacts.length ? (count / contacts.length * 100) : 0;
            return `
                <div class="stat-bar-item">
                    <span class="stat-bar-label">${range.label.split(' ')[0]}</span>
                    <div class="stat-bar-track">
                        <div class="stat-bar-fill" style="width: ${pct}%"></div>
                    </div>
                    <span class="stat-bar-count">${count}</span>
                </div>
            `;
        }).join('');

        // Tags breakdown
        const tagsBreakdown = document.getElementById('tags-breakdown');
        const tagCounts = {};
        contacts.forEach(c => c.tags?.forEach(t => {
            tagCounts[t.name] = (tagCounts[t.name] || 0) + 1;
        }));
        const topTags = Object.entries(tagCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);
        const maxTagCount = topTags.length ? topTags[0][1] : 1;

        tagsBreakdown.innerHTML = topTags.map(([name, count]) => `
            <div class="stat-bar-item">
                <span class="stat-bar-label">${name}</span>
                <div class="stat-bar-track">
                    <div class="stat-bar-fill" style="width: ${(count / maxTagCount * 100)}%"></div>
                </div>
                <span class="stat-bar-count">${count}</span>
            </div>
        `).join('') || '<div class="text-muted text-sm">No tags</div>';

        // Sources breakdown
        const sourcesBreakdown = document.getElementById('sources-breakdown');
        const sourceCounts = {
            'Email': contacts.filter(c => c.email).length,
            'Phone': contacts.filter(c => c.phone).length,
            'Matrix': Math.floor(contacts.length * 0.6),
            'Telegram': Math.floor(contacts.length * 0.3)
        };
        const maxSourceCount = Math.max(...Object.values(sourceCounts));

        sourcesBreakdown.innerHTML = Object.entries(sourceCounts).map(([name, count]) => `
            <div class="stat-bar-item">
                <span class="stat-bar-label">${name}</span>
                <div class="stat-bar-track">
                    <div class="stat-bar-fill" style="width: ${(count / maxSourceCount * 100)}%"></div>
                </div>
                <span class="stat-bar-count">${count}</span>
            </div>
        `).join('');

        // Activity breakdown
        const activityBreakdown = document.getElementById('activity-breakdown');
        const activityRanges = [
            { label: 'Very Active', min: 10 },
            { label: 'Active', min: 5, max: 9 },
            { label: 'Moderate', min: 1, max: 4 },
            { label: 'Inactive', min: 0, max: 0 }
        ];

        activityBreakdown.innerHTML = activityRanges.map(range => {
            const count = contacts.filter(c => {
                const msgs = c.last_week_messages || 0;
                if (range.max === undefined) return msgs >= range.min;
                return msgs >= range.min && msgs <= range.max;
            }).length;
            const pct = contacts.length ? (count / contacts.length * 100) : 0;
            return `
                <div class="stat-bar-item">
                    <span class="stat-bar-label">${range.label}</span>
                    <div class="stat-bar-track">
                        <div class="stat-bar-fill" style="width: ${pct}%"></div>
                    </div>
                    <span class="stat-bar-count">${count}</span>
                </div>
            `;
        }).join('');
    }

    // Render contacts based on current view
    function renderContacts() {
        const startIdx = (currentPage - 1) * pageSize;
        const pageContacts = filteredContacts.slice(startIdx, startIdx + pageSize);

        // Hide all views first
        document.getElementById('contacts-cards').style.display = 'none';
        document.getElementById('contacts-table-container').classList.remove('active');
        document.getElementById('contacts-compact').classList.remove('active');

        switch (currentView) {
            case 'cards':
                document.getElementById('contacts-cards').style.display = 'grid';
                renderCardsView(pageContacts);
                break;
            case 'table':
                document.getElementById('contacts-table-container').classList.add('active');
                renderTableView(pageContacts);
                break;
            case 'compact':
                document.getElementById('contacts-compact').classList.add('active');
                renderCompactView(pageContacts);
                break;
        }

        updateBulkActions();
        renderPagination();
    }

    // Render cards view
    function renderCardsView(pageContacts) {
        const container = document.getElementById('contacts-cards');

        if (pageContacts.length === 0) {
            container.innerHTML = `
                <div class="empty-state" style="grid-column: 1 / -1;">
                    <svg class="empty-state-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                    </svg>
                    <h3 class="empty-state-title">No contacts found</h3>
                    <p class="empty-state-description">Try adjusting your filters or add a new contact.</p>
                </div>
            `;
            return;
        }

        container.innerHTML = pageContacts.map(contact => {
            const avatarColor = Utils.stringToColor(contact.name);
            const initials = Utils.getInitials(contact.name);
            const isSelected = selectedContacts.has(contact.contact_id);

            return `
                <div class="contact-card ${isSelected ? 'selected' : ''}" data-id="${contact.contact_id}">
                    <input type="checkbox" class="contact-card-checkbox" ${isSelected ? 'checked' : ''}>
                    <div class="contact-card-header">
                        <div class="contact-avatar" style="background-color: ${avatarColor}">${initials}</div>
                        <div class="contact-info">
                            <div class="contact-name">${Utils.escapeHtml(contact.name)}</div>
                            <div class="contact-email">${contact.email || 'No email'}</div>
                        </div>
                    </div>
                    <div class="evaluation-bars">
                        <div class="eval-bar">
                            <span class="eval-label">Importance</span>
                            <div class="eval-track">
                                <div class="eval-fill importance" style="width: ${(contact.importance || 0) * 10}%"></div>
                            </div>
                            <span class="eval-value">${contact.importance || 0}</span>
                        </div>
                        <div class="eval-bar">
                            <span class="eval-label">Closeness</span>
                            <div class="eval-track">
                                <div class="eval-fill closeness" style="width: ${(contact.closeness || 0) * 10}%"></div>
                            </div>
                            <span class="eval-value">${contact.closeness || 0}</span>
                        </div>
                        <div class="eval-bar">
                            <span class="eval-label">Fondness</span>
                            <div class="eval-track">
                                <div class="eval-fill fondness" style="width: ${(contact.fondness || 0) * 10}%"></div>
                            </div>
                            <span class="eval-value">${contact.fondness || 0}</span>
                        </div>
                    </div>
                    <div class="contact-sources">
                        <div class="source-icon ${contact.email ? 'active' : ''}" title="Email">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                <polyline points="22,6 12,13 2,6"/>
                            </svg>
                        </div>
                        <div class="source-icon ${contact.phone ? 'active' : ''}" title="Phone">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                            </svg>
                        </div>
                        <div class="source-icon active" title="Matrix">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <path d="M9 9h6v6H9z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="contact-tags">
                        ${(contact.tags || []).slice(0, 3).map(tag => `
                            <span class="contact-tag">${Utils.escapeHtml(tag.name)}</span>
                        `).join('')}
                        ${(contact.tags || []).length > 3 ? `<span class="contact-tag">+${contact.tags.length - 3}</span>` : ''}
                    </div>
                    <div class="contact-actions">
                        <button class="contact-action-btn view-btn" title="View Details">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                            View
                        </button>
                        <button class="contact-action-btn message-btn" title="Send Message">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                            </svg>
                            Message
                        </button>
                        <button class="contact-action-btn edit-btn" title="Edit Contact">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                            Edit
                        </button>
                    </div>
                </div>
            `;
        }).join('');

        // Add event listeners
        container.querySelectorAll('.contact-card').forEach(card => {
            const id = card.dataset.id;
            const checkbox = card.querySelector('.contact-card-checkbox');

            checkbox.addEventListener('click', (e) => {
                e.stopPropagation();
                if (checkbox.checked) {
                    selectedContacts.add(id);
                } else {
                    selectedContacts.delete(id);
                }
                card.classList.toggle('selected', checkbox.checked);
                updateBulkActions();
            });

            card.querySelector('.view-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                openDetailPanel(id);
            });

            card.querySelector('.edit-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                const contact = contacts.find(c => c.contact_id === id);
                if (contact) openContactModal(contact);
            });

            card.querySelector('.message-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                app.toast.info('Opening messages...');
                window.location.hash = '#/messages';
            });

            card.addEventListener('click', () => {
                openDetailPanel(id);
            });
        });
    }

    // Render table view
    function renderTableView(pageContacts) {
        const tbody = document.getElementById('contacts-table-body');

        if (pageContacts.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7">
                        <div class="empty-state">
                            <p>No contacts found</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = pageContacts.map(contact => {
            const avatarColor = Utils.stringToColor(contact.name);
            const initials = Utils.getInitials(contact.name);
            const isSelected = selectedContacts.has(contact.contact_id);

            return `
                <tr class="${isSelected ? 'selected' : ''}" data-id="${contact.contact_id}">
                    <td class="checkbox-cell">
                        <input type="checkbox" class="row-checkbox" ${isSelected ? 'checked' : ''}>
                    </td>
                    <td>
                        <div class="table-name-cell">
                            <div class="table-avatar" style="background-color: ${avatarColor}">${initials}</div>
                            <span>${Utils.escapeHtml(contact.name)}</span>
                        </div>
                    </td>
                    <td class="text-muted">${contact.email || '-'}</td>
                    <td>
                        <div class="table-eval-mini" title="Importance: ${contact.importance}/10">
                            ${Array(10).fill(0).map((_, i) => `
                                <div class="eval-dot ${i < contact.importance ? 'filled' : ''}"></div>
                            `).join('')}
                        </div>
                    </td>
                    <td>
                        <div class="table-eval-mini" title="Closeness: ${contact.closeness}/10">
                            ${Array(10).fill(0).map((_, i) => `
                                <div class="eval-dot ${i < contact.closeness ? 'filled' : ''}"></div>
                            `).join('')}
                        </div>
                    </td>
                    <td>${contact.last_week_messages || 0}</td>
                    <td>
                        <div class="tag-list">
                            ${(contact.tags || []).slice(0, 2).map(tag => `
                                <span class="tag">${Utils.escapeHtml(tag.name)}</span>
                            `).join('')}
                        </div>
                    </td>
                </tr>
            `;
        }).join('');

        // Add event listeners
        tbody.querySelectorAll('tr').forEach(row => {
            const id = row.dataset.id;
            if (!id) return;

            const checkbox = row.querySelector('.row-checkbox');

            checkbox?.addEventListener('click', (e) => {
                e.stopPropagation();
                if (checkbox.checked) {
                    selectedContacts.add(id);
                } else {
                    selectedContacts.delete(id);
                }
                row.classList.toggle('selected', checkbox.checked);
                updateBulkActions();
            });

            row.addEventListener('click', () => {
                openDetailPanel(id);
            });
        });
    }

    // Render compact view
    function renderCompactView(pageContacts) {
        const container = document.getElementById('contacts-compact');

        if (pageContacts.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <p>No contacts found</p>
                </div>
            `;
            return;
        }

        container.innerHTML = pageContacts.map(contact => {
            const avatarColor = Utils.stringToColor(contact.name);
            const initials = Utils.getInitials(contact.name);
            const isSelected = selectedContacts.has(contact.contact_id);

            return `
                <div class="compact-item ${isSelected ? 'selected' : ''}" data-id="${contact.contact_id}">
                    <input type="checkbox" class="row-checkbox" ${isSelected ? 'checked' : ''}>
                    <div class="compact-avatar" style="background-color: ${avatarColor}">${initials}</div>
                    <div class="compact-info">
                        <div class="compact-name">${Utils.escapeHtml(contact.name)}</div>
                        <div class="compact-email">${contact.email || 'No email'}</div>
                    </div>
                    <div class="compact-meta">
                        <span class="badge badge-${contact.importance >= 7 ? 'success' : contact.importance >= 4 ? 'warning' : 'pending'}">${contact.importance}/10</span>
                        <span class="text-sm text-muted">${contact.last_week_messages || 0} msgs</span>
                    </div>
                </div>
            `;
        }).join('');

        // Add event listeners
        container.querySelectorAll('.compact-item').forEach(item => {
            const id = item.dataset.id;
            const checkbox = item.querySelector('.row-checkbox');

            checkbox.addEventListener('click', (e) => {
                e.stopPropagation();
                if (checkbox.checked) {
                    selectedContacts.add(id);
                } else {
                    selectedContacts.delete(id);
                }
                item.classList.toggle('selected', checkbox.checked);
                updateBulkActions();
            });

            item.addEventListener('click', () => {
                openDetailPanel(id);
            });
        });
    }

    // Render pagination
    function renderPagination() {
        const totalPages = Math.ceil(filteredContacts.length / pageSize);
        const container = document.getElementById('contacts-pagination');

        if (totalPages <= 1) {
            container.innerHTML = '';
            return;
        }

        const pagination = new Pagination({
            page: currentPage,
            totalPages: totalPages,
            onPageChange: (page) => {
                currentPage = page;
                renderContacts();
            }
        });

        container.innerHTML = pagination.render();
        pagination.attachEvents(container);
    }

    // Update bulk actions visibility
    function updateBulkActions() {
        const bulkBar = document.getElementById('bulk-actions');
        const count = selectedContacts.size;

        if (count > 0) {
            bulkBar.classList.add('visible');
            document.getElementById('selected-count').textContent = count;
        } else {
            bulkBar.classList.remove('visible');
        }
    }

    // Open detail panel
    function openDetailPanel(contactId) {
        const contact = contacts.find(c => c.contact_id === contactId);
        if (!contact) return;

        currentContactId = contactId;
        const avatarColor = Utils.stringToColor(contact.name);
        const initials = Utils.getInitials(contact.name);

        const content = document.getElementById('detail-panel-content');
        content.innerHTML = `
            <div class="detail-avatar-section">
                <div class="detail-avatar" style="background-color: ${avatarColor}">
                    ${initials}
                    <button class="detail-avatar-edit" title="Change photo">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                            <circle cx="12" cy="13" r="4"/>
                        </svg>
                    </button>
                </div>
                <div class="detail-name">${Utils.escapeHtml(contact.name)}</div>
                ${contact.known_names ? `<div class="detail-aliases">Also known as: ${contact.known_names}</div>` : ''}
            </div>

            <div class="detail-section">
                <div class="detail-section-title">Evaluation</div>
                <div class="eval-slider-group">
                    <div class="eval-slider-item">
                        <div class="eval-slider-header">
                            <span class="eval-slider-label">Importance</span>
                            <span class="eval-slider-value" id="importance-value">${contact.importance || 0}/10</span>
                        </div>
                        <input type="range" class="eval-slider importance" min="0" max="10" value="${contact.importance || 0}" data-field="importance">
                    </div>
                    <div class="eval-slider-item">
                        <div class="eval-slider-header">
                            <span class="eval-slider-label">Closeness</span>
                            <span class="eval-slider-value" id="closeness-value">${contact.closeness || 0}/10</span>
                        </div>
                        <input type="range" class="eval-slider closeness" min="0" max="10" value="${contact.closeness || 0}" data-field="closeness">
                    </div>
                    <div class="eval-slider-item">
                        <div class="eval-slider-header">
                            <span class="eval-slider-label">Fondness</span>
                            <span class="eval-slider-value" id="fondness-value">${contact.fondness || 0}/10</span>
                        </div>
                        <input type="range" class="eval-slider fondness" min="0" max="10" value="${contact.fondness || 0}" data-field="fondness">
                    </div>
                </div>
            </div>

            <div class="detail-section">
                <div class="detail-section-title">Contact Information</div>
                <div class="detail-info-list">
                    <div class="detail-info-item">
                        <svg class="detail-info-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                            <polyline points="22,6 12,13 2,6"/>
                        </svg>
                        <div class="detail-info-content">
                            <div class="detail-info-label">Email</div>
                            <div class="detail-info-value">${contact.email ? `<a href="mailto:${contact.email}">${contact.email}</a>` : 'Not set'}</div>
                        </div>
                    </div>
                    <div class="detail-info-item">
                        <svg class="detail-info-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                        </svg>
                        <div class="detail-info-content">
                            <div class="detail-info-label">Phone</div>
                            <div class="detail-info-value">${contact.phone ? `<a href="tel:${contact.phone}">${contact.phone}</a>` : 'Not set'}</div>
                        </div>
                    </div>
                    <div class="detail-info-item">
                        <svg class="detail-info-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                        <div class="detail-info-content">
                            <div class="detail-info-label">Birthday</div>
                            <div class="detail-info-value">${contact.birthday ? Utils.formatDate(contact.birthday) : 'Not set'}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="detail-section">
                <div class="detail-section-title">Tags</div>
                <div class="detail-tags">
                    ${(contact.tags || []).map(tag => `
                        <span class="detail-tag">
                            ${Utils.escapeHtml(tag.name)}
                            <span class="detail-tag-remove" data-tag="${tag.name}">x</span>
                        </span>
                    `).join('')}
                    <button class="add-tag-btn" id="add-tag-btn">+ Add Tag</button>
                </div>
            </div>

            <div class="detail-section">
                <div class="detail-section-title">Rooms (${contact.groups_in_common || 0})</div>
                <div class="rooms-list">
                    ${contact.groups_in_common > 0 ? `
                        <div class="room-item">
                            <svg class="room-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                            </svg>
                            <span class="room-name">Engineering Team</span>
                            <span class="room-count">12 members</span>
                        </div>
                        <div class="room-item">
                            <svg class="room-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                            </svg>
                            <span class="room-name">Product Discussion</span>
                            <span class="room-count">8 members</span>
                        </div>
                    ` : '<div class="text-muted text-sm">No shared rooms</div>'}
                </div>
            </div>

            <div class="detail-section">
                <div class="detail-section-title">Recent Messages</div>
                <div class="recent-messages">
                    ${contact.last_week_messages > 0 ? `
                        <div class="recent-message">
                            <div class="recent-message-content">"Let's sync on the API changes tomorrow."</div>
                            <div class="recent-message-time">2 hours ago</div>
                        </div>
                        <div class="recent-message">
                            <div class="recent-message-content">"Great progress on the sprint!"</div>
                            <div class="recent-message-time">Yesterday</div>
                        </div>
                    ` : '<div class="text-muted text-sm">No recent messages</div>'}
                </div>
            </div>

            <div class="detail-section">
                <div class="detail-section-title">Notes</div>
                <textarea class="contact-notes" id="contact-notes" placeholder="Add notes about this contact...">${contact.notes || ''}</textarea>
            </div>

            <div class="detail-section">
                <div class="detail-section-title">Activity Timeline</div>
                <div class="activity-timeline">
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">Contact updated</div>
                        <div class="timeline-time">${Utils.formatRelativeTime(contact.last_update)}</div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">Contact created</div>
                        <div class="timeline-time">${Utils.formatDate(contact.creation_date)}</div>
                    </div>
                </div>
            </div>
        `;

        // Setup evaluation slider listeners
        content.querySelectorAll('.eval-slider').forEach(slider => {
            slider.addEventListener('input', (e) => {
                const field = e.target.dataset.field;
                const value = e.target.value;
                document.getElementById(`${field}-value`).textContent = `${value}/10`;
            });

            slider.addEventListener('change', async (e) => {
                const field = e.target.dataset.field;
                const value = parseInt(e.target.value);

                // Optimistic update
                contact[field] = value;

                try {
                    await app.api.updateContactEvaluation(contactId, { [field]: value });
                    app.toast.success(`${field.charAt(0).toUpperCase() + field.slice(1)} updated`);
                    renderContacts();
                } catch (err) {
                    app.toast.error('Failed to update evaluation');
                }
            });
        });

        // Notes auto-save
        const notesTextarea = content.querySelector('#contact-notes');
        let notesTimeout;
        notesTextarea.addEventListener('input', () => {
            clearTimeout(notesTimeout);
            notesTimeout = setTimeout(async () => {
                try {
                    await app.api.updateContact(contactId, { notes: notesTextarea.value });
                    contact.notes = notesTextarea.value;
                } catch (err) {
                    console.error('Failed to save notes');
                }
            }, 1000);
        });

        document.getElementById('detail-panel-overlay').classList.add('active');
    }

    // Close detail panel
    function closeDetailPanel() {
        document.getElementById('detail-panel-overlay').classList.remove('active');
        currentContactId = null;
    }

    // Open contact modal for add/edit
    function openContactModal(contact = null) {
        const isEdit = !!contact;

        app.modal.open({
            title: isEdit ? 'Edit Contact' : 'Add New Contact',
            content: `
                <div class="modal-form">
                    <div class="modal-form-group">
                        <label class="modal-form-label">Name *</label>
                        <input type="text" class="modal-form-input" id="modal-name" value="${contact?.name || ''}" required>
                    </div>
                    <div class="modal-form-group">
                        <label class="modal-form-label">Email</label>
                        <input type="email" class="modal-form-input" id="modal-email" value="${contact?.email || ''}">
                    </div>
                    <div class="modal-form-group">
                        <label class="modal-form-label">Phone</label>
                        <input type="tel" class="modal-form-input" id="modal-phone" value="${contact?.phone || ''}">
                    </div>
                    <div class="modal-form-group">
                        <label class="modal-form-label">Birthday</label>
                        <input type="date" class="modal-form-input" id="modal-birthday" value="${contact?.birthday || ''}">
                    </div>
                    <div class="modal-form-group">
                        <label class="modal-form-label">Known Names</label>
                        <div class="known-names-list" id="known-names-list"></div>
                        <div class="add-known-name">
                            <input type="text" id="new-known-name" placeholder="Add alias...">
                            <button class="btn btn-secondary btn-sm" id="add-known-name-btn">Add</button>
                        </div>
                    </div>
                    <div class="modal-form-group">
                        <label class="modal-form-label">Importance (${contact?.importance || 5}/10)</label>
                        <input type="range" class="eval-slider importance" min="0" max="10" value="${contact?.importance || 5}" id="modal-importance">
                    </div>
                    <div class="modal-form-group">
                        <label class="modal-form-label">Closeness (${contact?.closeness || 5}/10)</label>
                        <input type="range" class="eval-slider closeness" min="0" max="10" value="${contact?.closeness || 5}" id="modal-closeness">
                    </div>
                    <div class="modal-form-group">
                        <label class="modal-form-label">Fondness (${contact?.fondness || 5}/10)</label>
                        <input type="range" class="eval-slider fondness" min="0" max="10" value="${contact?.fondness || 5}" id="modal-fondness">
                    </div>
                    <div class="modal-form-group">
                        <label class="modal-form-label">Tags</label>
                        <input type="text" class="modal-form-input" id="modal-tags" placeholder="Enter tags separated by commas" value="${(contact?.tags || []).map(t => t.name).join(', ')}">
                    </div>
                    <div class="modal-form-group">
                        <label class="modal-form-label">Notes</label>
                        <textarea class="modal-form-input" id="modal-notes" rows="3">${contact?.notes || ''}</textarea>
                    </div>
                </div>
            `,
            footer: `
                <button class="btn btn-secondary" onclick="app.modal.close()">Cancel</button>
                <button class="btn btn-primary" id="modal-save-btn">${isEdit ? 'Save Changes' : 'Add Contact'}</button>
            `
        });

        // Update slider labels
        ['importance', 'closeness', 'fondness'].forEach(field => {
            const slider = document.getElementById(`modal-${field}`);
            const label = slider.previousElementSibling;
            slider.addEventListener('input', (e) => {
                label.textContent = `${field.charAt(0).toUpperCase() + field.slice(1)} (${e.target.value}/10)`;
            });
        });

        // Save handler
        document.getElementById('modal-save-btn').addEventListener('click', async () => {
            const name = document.getElementById('modal-name').value.trim();
            if (!name) {
                app.toast.warning('Name is required');
                return;
            }

            const data = {
                name,
                email: document.getElementById('modal-email').value.trim() || null,
                phone: document.getElementById('modal-phone').value.trim() || null,
                birthday: document.getElementById('modal-birthday').value || null,
                importance: parseInt(document.getElementById('modal-importance').value),
                closeness: parseInt(document.getElementById('modal-closeness').value),
                fondness: parseInt(document.getElementById('modal-fondness').value),
                notes: document.getElementById('modal-notes').value.trim(),
                tags: document.getElementById('modal-tags').value
                    .split(',')
                    .map(t => t.trim())
                    .filter(t => t)
                    .map(name => ({ tag_id: 'tg_' + name, name }))
            };

            try {
                if (isEdit) {
                    await app.api.updateContact(contact.contact_id, data);
                    Object.assign(contact, data);
                    app.toast.success('Contact updated');
                } else {
                    const newContact = {
                        contact_id: 'ct_' + Date.now(),
                        ...data,
                        creation_date: new Date().toISOString(),
                        last_update: new Date().toISOString(),
                        last_week_messages: 0,
                        groups_in_common: 0
                    };
                    contacts.push(newContact);
                    app.toast.success('Contact added');
                }
                filterContacts();
                app.modal.close();
                if (currentContactId) {
                    closeDetailPanel();
                }
            } catch (err) {
                app.toast.error('Failed to save contact');
            }
        });
    }

    // Bulk tag modal
    function openBulkTagModal() {
        app.modal.open({
            title: 'Add Tags to Selected Contacts',
            content: `
                <div class="modal-form">
                    <div class="modal-form-group">
                        <label class="modal-form-label">Tags (comma-separated)</label>
                        <input type="text" class="modal-form-input" id="bulk-tags-input" placeholder="tech, important, follow-up">
                    </div>
                </div>
            `,
            footer: `
                <button class="btn btn-secondary" onclick="app.modal.close()">Cancel</button>
                <button class="btn btn-primary" id="bulk-tags-save">Apply Tags</button>
            `
        });

        document.getElementById('bulk-tags-save').addEventListener('click', async () => {
            const tagsInput = document.getElementById('bulk-tags-input').value;
            const newTags = tagsInput.split(',').map(t => t.trim()).filter(t => t);

            if (newTags.length === 0) {
                app.toast.warning('Please enter at least one tag');
                return;
            }

            selectedContacts.forEach(id => {
                const contact = contacts.find(c => c.contact_id === id);
                if (contact) {
                    const existingTags = new Set((contact.tags || []).map(t => t.name));
                    newTags.forEach(tag => {
                        if (!existingTags.has(tag)) {
                            contact.tags = contact.tags || [];
                            contact.tags.push({ tag_id: 'tg_' + tag, name: tag });
                        }
                    });
                }
            });

            app.toast.success(`Tags applied to ${selectedContacts.size} contacts`);
            selectedContacts.clear();
            updateBulkActions();
            renderContacts();
            populateFilters();
            app.modal.close();
        });
    }

    // Export selected contacts
    function exportSelected() {
        const selected = contacts.filter(c => selectedContacts.has(c.contact_id));
        const csv = [
            ['Name', 'Email', 'Phone', 'Importance', 'Closeness', 'Fondness', 'Tags', 'Notes'].join(','),
            ...selected.map(c => [
                `"${c.name}"`,
                `"${c.email || ''}"`,
                `"${c.phone || ''}"`,
                c.importance || 0,
                c.closeness || 0,
                c.fondness || 0,
                `"${(c.tags || []).map(t => t.name).join(';')}"`,
                `"${(c.notes || '').replace(/"/g, '""')}"`
            ].join(','))
        ].join('\n');

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'contacts-export.csv';
        a.click();
        URL.revokeObjectURL(url);

        app.toast.success(`Exported ${selected.length} contacts`);
    }

    // Merge modal
    function openMergeModal() {
        if (selectedContacts.size < 2) {
            app.toast.warning('Select at least 2 contacts to merge');
            return;
        }

        const selected = contacts.filter(c => selectedContacts.has(c.contact_id));

        app.modal.open({
            title: 'Merge Contacts',
            content: `
                <div class="modal-form">
                    <p class="text-muted mb-4">Select the primary contact. Other contacts will be merged into this one.</p>
                    <div class="modal-form-group">
                        <label class="modal-form-label">Primary Contact</label>
                        <select class="modal-form-input" id="merge-primary">
                            ${selected.map(c => `<option value="${c.contact_id}">${c.name}</option>`).join('')}
                        </select>
                    </div>
                    <p class="text-sm text-muted">
                        Tags and notes from all contacts will be combined.
                        Email and phone from the primary contact will be kept.
                    </p>
                </div>
            `,
            footer: `
                <button class="btn btn-secondary" onclick="app.modal.close()">Cancel</button>
                <button class="btn btn-primary" id="merge-confirm">Merge Contacts</button>
            `
        });

        document.getElementById('merge-confirm').addEventListener('click', () => {
            const primaryId = document.getElementById('merge-primary').value;
            const primary = contacts.find(c => c.contact_id === primaryId);
            const others = selected.filter(c => c.contact_id !== primaryId);

            // Merge tags
            const allTags = new Set((primary.tags || []).map(t => t.name));
            others.forEach(c => {
                (c.tags || []).forEach(t => allTags.add(t.name));
            });
            primary.tags = Array.from(allTags).map(name => ({ tag_id: 'tg_' + name, name }));

            // Merge notes
            const allNotes = [primary.notes, ...others.map(c => c.notes)].filter(n => n).join('\n---\n');
            primary.notes = allNotes;

            // Remove merged contacts
            others.forEach(c => {
                const idx = contacts.findIndex(ct => ct.contact_id === c.contact_id);
                if (idx > -1) contacts.splice(idx, 1);
            });

            selectedContacts.clear();
            updateBulkActions();
            filterContacts();
            app.toast.success(`Merged ${others.length + 1} contacts`);
            app.modal.close();
        });
    }

    // Initialize on load
    init();
})();
</script>
