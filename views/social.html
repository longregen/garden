<div class="page-header">
    <h1 class="page-title">Social Posts</h1>
    <p class="page-description">Compose, schedule, and manage your social media presence</p>
</div>

<!-- Navigation Tabs -->
<div class="tabs" id="social-tabs">
    <button class="tab active" data-tab="compose" onclick="socialApp.switchTab('compose')">Compose</button>
    <button class="tab" data-tab="feed" onclick="socialApp.switchTab('feed')">Posts Feed</button>
    <button class="tab" data-tab="scheduled" onclick="socialApp.switchTab('scheduled')">Scheduled</button>
    <button class="tab" data-tab="drafts" onclick="socialApp.switchTab('drafts')">Drafts</button>
    <button class="tab" data-tab="analytics" onclick="socialApp.switchTab('analytics')">Analytics</button>
    <button class="tab" data-tab="credentials" onclick="socialApp.switchTab('credentials')">Accounts</button>
    <button class="tab" data-tab="templates" onclick="socialApp.switchTab('templates')">Templates</button>
</div>

<div id="social-content">
    <!-- Loading state will be replaced by actual content -->
    <div class="loading-state">
        <div class="loading-spinner"></div>
        <p>Loading...</p>
    </div>
</div>

<script>
// Social App Module
const socialApp = {
    posts: [],
    credentials: null,
    currentTab: 'compose',
    templates: [],
    drafts: [],

    // Character limits per platform
    charLimits: {
        twitter: 280,
        bluesky: 300
    },

    // Initialize the social app
    async init() {
        try {
            const [postsResult, credentials] = await Promise.all([
                window.app.api.getSocialPosts({ page: 1, limit: 100 }),
                window.app.api.getSocialCredentials()
            ]);
            this.posts = postsResult.data || [];
            this.credentials = credentials;
            this.loadTemplates();
            this.renderTab(this.currentTab);
        } catch (error) {
            console.error('Failed to initialize social app:', error);
            window.app.toast.error('Failed to load social data');
        }
    },

    // Load templates from localStorage
    loadTemplates() {
        const saved = localStorage.getItem('social_templates');
        this.templates = saved ? JSON.parse(saved) : [
            { id: 't1', name: 'Product Launch', content: 'Excited to announce our latest feature! Check it out at [link]' },
            { id: 't2', name: 'Blog Post Share', content: 'New blog post: "[title]" - Read more at [link]' },
            { id: 't3', name: 'Quick Update', content: 'Quick update: [message]' }
        ];
    },

    // Save templates to localStorage
    saveTemplates() {
        localStorage.setItem('social_templates', JSON.stringify(this.templates));
    },

    // Switch between tabs
    switchTab(tab) {
        this.currentTab = tab;
        document.querySelectorAll('#social-tabs .tab').forEach(t => {
            t.classList.toggle('active', t.dataset.tab === tab);
        });
        this.renderTab(tab);
    },

    // Render the current tab
    renderTab(tab) {
        const container = document.getElementById('social-content');
        switch (tab) {
            case 'compose':
                this.renderCompose(container);
                break;
            case 'feed':
                this.renderFeed(container);
                break;
            case 'scheduled':
                this.renderScheduled(container);
                break;
            case 'drafts':
                this.renderDrafts(container);
                break;
            case 'analytics':
                this.renderAnalytics(container);
                break;
            case 'credentials':
                this.renderCredentials(container);
                break;
            case 'templates':
                this.renderTemplates(container);
                break;
        }
    },

    // ==========================================
    // COMPOSE SECTION
    // ==========================================
    renderCompose(container) {
        container.innerHTML = `
            <div class="grid" style="grid-template-columns: 1fr 380px; gap: var(--space-6);">
                <!-- Compose Area -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Create Post</h3>
                        <div class="flex gap-2">
                            <button class="btn btn-ghost btn-sm" onclick="socialApp.loadFromTemplate()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14,2 14,8 20,8"/>
                                </svg>
                                Use Template
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Content Textarea -->
                        <div class="form-group">
                            <label class="form-label">Post Content</label>
                            <textarea
                                class="form-textarea"
                                id="compose-content"
                                placeholder="What's on your mind?"
                                rows="6"
                                oninput="socialApp.updateCharCount()"
                            ></textarea>
                            <div class="flex justify-between items-center mt-2">
                                <div id="char-counter" class="text-sm">
                                    <span id="char-count">0</span> characters
                                </div>
                                <div id="char-warnings" class="text-sm"></div>
                            </div>
                            <div id="thread-suggestion" class="mt-2" style="display: none;">
                                <div class="flex items-center gap-2 text-warning text-sm">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"/>
                                        <line x1="12" y1="8" x2="12" y2="12"/>
                                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                                    </svg>
                                    Content exceeds Twitter limit. Consider splitting into a thread.
                                    <button class="btn btn-ghost btn-sm" onclick="socialApp.suggestThread()">Auto-split</button>
                                </div>
                            </div>
                        </div>

                        <!-- Platform Selection -->
                        <div class="form-group">
                            <label class="form-label">Platforms</label>
                            <div class="flex gap-4">
                                <label class="flex items-center gap-2" style="cursor: pointer;">
                                    <input type="checkbox" id="platform-twitter" checked onchange="socialApp.updatePreviews()">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                                    </svg>
                                    <span>Twitter/X</span>
                                </label>
                                <label class="flex items-center gap-2" style="cursor: pointer;">
                                    <input type="checkbox" id="platform-bluesky" checked onchange="socialApp.updatePreviews()">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 10.8c-1.087-2.114-4.046-6.053-6.798-7.995C2.566.944 1.561 1.266.902 1.565.139 1.908 0 3.08 0 3.768c0 .69.378 5.65.624 6.479.815 2.736 3.713 3.66 6.383 3.364.136-.02.275-.039.415-.056-.138.022-.276.04-.415.054-3.182.391-6.2-.655-6.383-3.364-.065-.237-.624-5.789-.624-6.479 0-.688.139-1.86.902-2.203.659-.299 1.664-.621 4.3 1.24 2.752 1.942 5.711 5.881 6.798 7.995zm0 2.4c1.087 2.114 4.046 6.053 6.798 7.995 2.636 1.861 3.641 1.54 4.3 1.24.763-.343.902-1.515.902-2.203 0-.69-.378-5.65-.624-6.479-.815-2.736-3.713-3.66-6.383-3.364-.136.02-.275.039-.415.056.138-.022.276-.04.415-.054 3.182-.391 6.2.655 6.383 3.364.065.237.624 5.789.624 6.479 0 .688-.139 1.86-.902 2.203-.659.299-1.664.621-4.3-1.24-2.752-1.942-5.711-5.881-6.798-7.995z"/>
                                    </svg>
                                    <span>Bluesky</span>
                                </label>
                            </div>
                        </div>

                        <!-- Media Attachments -->
                        <div class="form-group">
                            <label class="form-label">Media Attachments</label>
                            <div class="flex gap-2">
                                <button class="btn btn-secondary btn-sm" onclick="socialApp.addMedia('image')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <polyline points="21,15 16,10 5,21"/>
                                    </svg>
                                    Image
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="socialApp.addMedia('video')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polygon points="23,7 16,12 23,17 23,7"/>
                                        <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                                    </svg>
                                    Video
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="socialApp.addMedia('gif')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                                        <text x="6" y="16" font-size="8" fill="currentColor">GIF</text>
                                    </svg>
                                    GIF
                                </button>
                            </div>
                            <div id="media-preview" class="mt-4" style="display: none;">
                                <div class="flex gap-2 flex-wrap" id="media-items"></div>
                            </div>
                        </div>

                        <!-- Schedule Options -->
                        <div class="form-group">
                            <label class="flex items-center gap-2" style="cursor: pointer;">
                                <input type="checkbox" id="schedule-toggle" onchange="socialApp.toggleSchedule()">
                                <span class="form-label" style="margin: 0;">Schedule for later</span>
                            </label>
                            <div id="schedule-options" style="display: none; margin-top: var(--space-3);">
                                <div class="grid grid-cols-2" style="gap: var(--space-3);">
                                    <div>
                                        <label class="form-label text-sm">Date</label>
                                        <input type="date" class="form-input" id="schedule-date">
                                    </div>
                                    <div>
                                        <label class="form-label text-sm">Time</label>
                                        <input type="time" class="form-input" id="schedule-time">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <button class="btn btn-secondary" onclick="socialApp.saveDraft()">Save Draft</button>
                        <button class="btn btn-secondary" onclick="socialApp.saveAsTemplate()">Save as Template</button>
                        <button class="btn btn-primary" id="post-button" onclick="socialApp.submitPost()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"/>
                                <polygon points="22,2 15,22 11,13 2,9 22,2"/>
                            </svg>
                            Post Now
                        </button>
                    </div>
                </div>

                <!-- Preview Panel -->
                <div>
                    <div class="card mb-4" id="twitter-preview-card">
                        <div class="card-header">
                            <div class="flex items-center gap-2">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                                </svg>
                                <h4 class="card-title" style="font-size: var(--font-size-base);">Twitter/X Preview</h4>
                            </div>
                            <span id="twitter-char-badge" class="badge badge-success">0/280</span>
                        </div>
                        <div class="card-body" id="twitter-preview">
                            <div class="flex gap-3">
                                <div class="avatar avatar-sm" style="background-color: hsl(200, 50%, 50%);">
                                    ${this.credentials?.twitter?.profile?.username?.charAt(0)?.toUpperCase() || 'U'}
                                </div>
                                <div style="flex: 1;">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="font-semibold">${this.credentials?.twitter?.profile?.displayName || 'Your Name'}</span>
                                        <span class="text-muted text-sm">@${this.credentials?.twitter?.profile?.username || 'username'}</span>
                                    </div>
                                    <p id="twitter-preview-content" class="text-sm" style="white-space: pre-wrap;">Your post will appear here...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card" id="bluesky-preview-card">
                        <div class="card-header">
                            <div class="flex items-center gap-2">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 10.8c-1.087-2.114-4.046-6.053-6.798-7.995C2.566.944 1.561 1.266.902 1.565.139 1.908 0 3.08 0 3.768c0 .69.378 5.65.624 6.479.815 2.736 3.713 3.66 6.383 3.364.136-.02.275-.039.415-.056-.138.022-.276.04-.415.054-3.182.391-6.2-.655-6.383-3.364-.065-.237-.624-5.789-.624-6.479 0-.688.139-1.86.902-2.203.659-.299 1.664-.621 4.3 1.24 2.752 1.942 5.711 5.881 6.798 7.995zm0 2.4c1.087 2.114 4.046 6.053 6.798 7.995 2.636 1.861 3.641 1.54 4.3 1.24.763-.343.902-1.515.902-2.203 0-.69-.378-5.65-.624-6.479-.815-2.736-3.713-3.66-6.383-3.364-.136.02-.275.039-.415.056.138-.022.276-.04.415-.054 3.182-.391 6.2.655 6.383 3.364.065.237.624 5.789.624 6.479 0 .688-.139 1.86-.902 2.203-.659.299-1.664.621-4.3-1.24-2.752-1.942-5.711-5.881-6.798-7.995z"/>
                                </svg>
                                <h4 class="card-title" style="font-size: var(--font-size-base);">Bluesky Preview</h4>
                            </div>
                            <span id="bluesky-char-badge" class="badge badge-success">0/300</span>
                        </div>
                        <div class="card-body" id="bluesky-preview">
                            <div class="flex gap-3">
                                <div class="avatar avatar-sm" style="background-color: hsl(210, 50%, 50%);">
                                    ${this.credentials?.bluesky?.profile?.handle?.charAt(0)?.toUpperCase() || 'U'}
                                </div>
                                <div style="flex: 1;">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="font-semibold">${this.credentials?.bluesky?.profile?.displayName || 'Your Name'}</span>
                                        <span class="text-muted text-sm">@${this.credentials?.bluesky?.profile?.handle || 'handle.bsky.social'}</span>
                                    </div>
                                    <p id="bluesky-preview-content" class="text-sm" style="white-space: pre-wrap;">Your post will appear here...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        this.updatePreviews();
    },

    updateCharCount() {
        const content = document.getElementById('compose-content')?.value || '';
        const charCount = content.length;
        const charCountEl = document.getElementById('char-count');
        const charWarnings = document.getElementById('char-warnings');
        const threadSuggestion = document.getElementById('thread-suggestion');
        const twitterBadge = document.getElementById('twitter-char-badge');
        const blueskyBadge = document.getElementById('bluesky-char-badge');

        if (charCountEl) charCountEl.textContent = charCount;

        // Twitter character indicator
        if (twitterBadge) {
            twitterBadge.textContent = `${charCount}/${this.charLimits.twitter}`;
            if (charCount > this.charLimits.twitter) {
                twitterBadge.className = 'badge badge-error';
            } else if (charCount > this.charLimits.twitter * 0.9) {
                twitterBadge.className = 'badge badge-warning';
            } else {
                twitterBadge.className = 'badge badge-success';
            }
        }

        // Bluesky character indicator
        if (blueskyBadge) {
            blueskyBadge.textContent = `${charCount}/${this.charLimits.bluesky}`;
            if (charCount > this.charLimits.bluesky) {
                blueskyBadge.className = 'badge badge-error';
            } else if (charCount > this.charLimits.bluesky * 0.9) {
                blueskyBadge.className = 'badge badge-warning';
            } else {
                blueskyBadge.className = 'badge badge-success';
            }
        }

        // Warning messages
        const warnings = [];
        if (charCount > this.charLimits.twitter) {
            warnings.push(`<span class="text-error">Over Twitter limit by ${charCount - this.charLimits.twitter}</span>`);
        }
        if (charCount > this.charLimits.bluesky) {
            warnings.push(`<span class="text-error">Over Bluesky limit by ${charCount - this.charLimits.bluesky}</span>`);
        }
        if (charWarnings) charWarnings.innerHTML = warnings.join(' | ');

        // Thread suggestion
        if (threadSuggestion) {
            threadSuggestion.style.display = charCount > this.charLimits.twitter ? 'block' : 'none';
        }

        this.updatePreviews();
    },

    updatePreviews() {
        const content = document.getElementById('compose-content')?.value || 'Your post will appear here...';
        const twitterEnabled = document.getElementById('platform-twitter')?.checked;
        const blueskyEnabled = document.getElementById('platform-bluesky')?.checked;

        const twitterPreview = document.getElementById('twitter-preview-content');
        const blueskyPreview = document.getElementById('bluesky-preview-content');
        const twitterCard = document.getElementById('twitter-preview-card');
        const blueskyCard = document.getElementById('bluesky-preview-card');

        if (twitterPreview) twitterPreview.textContent = content || 'Your post will appear here...';
        if (blueskyPreview) blueskyPreview.textContent = content || 'Your post will appear here...';
        if (twitterCard) twitterCard.style.opacity = twitterEnabled ? '1' : '0.5';
        if (blueskyCard) blueskyCard.style.opacity = blueskyEnabled ? '1' : '0.5';

        // Update post button text
        const postButton = document.getElementById('post-button');
        const scheduleEnabled = document.getElementById('schedule-toggle')?.checked;
        if (postButton) {
            postButton.innerHTML = scheduleEnabled ?
                `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg> Schedule` :
                `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22,2 15,22 11,13 2,9 22,2"/></svg> Post Now`;
        }
    },

    toggleSchedule() {
        const options = document.getElementById('schedule-options');
        const toggle = document.getElementById('schedule-toggle');
        if (options && toggle) {
            options.style.display = toggle.checked ? 'block' : 'none';

            // Set default date/time
            if (toggle.checked) {
                const now = new Date();
                now.setHours(now.getHours() + 1);
                document.getElementById('schedule-date').value = now.toISOString().split('T')[0];
                document.getElementById('schedule-time').value = now.toTimeString().slice(0, 5);
            }
        }
        this.updatePreviews();
    },

    addMedia(type) {
        const preview = document.getElementById('media-preview');
        const items = document.getElementById('media-items');
        preview.style.display = 'block';

        const mediaItem = document.createElement('div');
        mediaItem.className = 'flex items-center gap-2 p-2 bg-elevated border rounded';
        mediaItem.style.cssText = 'background: var(--color-background-active); border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--space-2) var(--space-3);';
        mediaItem.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                ${type === 'image' ? '<rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21,15 16,10 5,21"/>' :
                  type === 'video' ? '<polygon points="23,7 16,12 23,17"/><rect x="1" y="5" width="15" height="14" rx="2"/>' :
                  '<rect x="3" y="3" width="18" height="18" rx="2"/>'}
            </svg>
            <span class="text-sm">${type}_placeholder.${type === 'image' ? 'jpg' : type === 'video' ? 'mp4' : 'gif'}</span>
            <button class="btn btn-ghost btn-sm" onclick="this.parentElement.remove()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        `;
        items.appendChild(mediaItem);
        window.app.toast.info(`${type.charAt(0).toUpperCase() + type.slice(1)} attachment added (placeholder)`);
    },

    suggestThread() {
        const content = document.getElementById('compose-content').value;
        const limit = this.charLimits.twitter - 10; // Leave room for numbering
        const words = content.split(' ');
        const tweets = [];
        let current = '';

        words.forEach(word => {
            if ((current + ' ' + word).trim().length > limit) {
                tweets.push(current.trim());
                current = word;
            } else {
                current = current ? current + ' ' + word : word;
            }
        });
        if (current.trim()) tweets.push(current.trim());

        const threadContent = tweets.map((t, i) => `${i + 1}/${tweets.length} ${t}`).join('\n\n---\n\n');
        document.getElementById('compose-content').value = threadContent;
        this.updateCharCount();
        window.app.toast.info(`Split into ${tweets.length} tweets`);
    },

    async submitPost() {
        const content = document.getElementById('compose-content').value.trim();
        const twitterEnabled = document.getElementById('platform-twitter').checked;
        const blueskyEnabled = document.getElementById('platform-bluesky').checked;
        const scheduleEnabled = document.getElementById('schedule-toggle').checked;

        if (!content) {
            window.app.toast.warning('Please enter some content');
            return;
        }

        if (!twitterEnabled && !blueskyEnabled) {
            window.app.toast.warning('Please select at least one platform');
            return;
        }

        try {
            const postData = {
                content,
                platforms: {
                    twitter: twitterEnabled,
                    bluesky: blueskyEnabled
                }
            };

            if (scheduleEnabled) {
                const date = document.getElementById('schedule-date').value;
                const time = document.getElementById('schedule-time').value;
                postData.scheduledAt = new Date(`${date}T${time}`).toISOString();
            }

            await window.app.api.createSocialPost(postData);
            window.app.toast.success(scheduleEnabled ? 'Post scheduled successfully!' : 'Post created successfully!');
            document.getElementById('compose-content').value = '';
            this.updateCharCount();
            await this.init();
        } catch (error) {
            window.app.toast.error('Failed to create post');
        }
    },

    saveDraft() {
        const content = document.getElementById('compose-content').value.trim();
        if (!content) {
            window.app.toast.warning('Please enter some content');
            return;
        }

        const draft = {
            id: 'd' + Date.now(),
            content,
            platforms: {
                twitter: document.getElementById('platform-twitter').checked,
                bluesky: document.getElementById('platform-bluesky').checked
            },
            created_at: new Date().toISOString()
        };

        const drafts = JSON.parse(localStorage.getItem('social_drafts') || '[]');
        drafts.unshift(draft);
        localStorage.setItem('social_drafts', JSON.stringify(drafts));
        window.app.toast.success('Draft saved!');
        document.getElementById('compose-content').value = '';
        this.updateCharCount();
    },

    saveAsTemplate() {
        const content = document.getElementById('compose-content').value.trim();
        if (!content) {
            window.app.toast.warning('Please enter some content');
            return;
        }

        const name = prompt('Enter template name:');
        if (!name) return;

        this.templates.push({
            id: 't' + Date.now(),
            name,
            content
        });
        this.saveTemplates();
        window.app.toast.success('Template saved!');
    },

    loadFromTemplate() {
        const options = this.templates.map(t => `<option value="${t.id}">${Utils.escapeHtml(t.name)}</option>`).join('');

        window.app.modal.open({
            title: 'Select Template',
            content: `
                <div class="form-group">
                    <label class="form-label">Choose a template</label>
                    <select class="form-select" id="template-select">
                        <option value="">-- Select --</option>
                        ${options}
                    </select>
                </div>
                <div id="template-preview" class="mt-4" style="display: none;">
                    <label class="form-label">Preview</label>
                    <div class="code-block text-sm" id="template-preview-content"></div>
                </div>
            `,
            footer: `
                <button class="btn btn-secondary" onclick="window.app.modal.close()">Cancel</button>
                <button class="btn btn-primary" onclick="socialApp.applyTemplate()">Use Template</button>
            `
        });

        document.getElementById('template-select').addEventListener('change', (e) => {
            const template = this.templates.find(t => t.id === e.target.value);
            const preview = document.getElementById('template-preview');
            const previewContent = document.getElementById('template-preview-content');
            if (template) {
                preview.style.display = 'block';
                previewContent.textContent = template.content;
            } else {
                preview.style.display = 'none';
            }
        });
    },

    applyTemplate() {
        const select = document.getElementById('template-select');
        const template = this.templates.find(t => t.id === select.value);
        if (template) {
            document.getElementById('compose-content').value = template.content;
            this.updateCharCount();
            window.app.modal.close();
        }
    },

    // ==========================================
    // POSTS FEED SECTION
    // ==========================================
    renderFeed(container) {
        const statusColors = {
            posted: 'success',
            completed: 'success',
            draft: 'pending',
            failed: 'error',
            pending: 'warning',
            partial: 'warning'
        };

        // Mock engagement data
        const mockEngagement = () => ({
            likes: Math.floor(Math.random() * 500),
            retweets: Math.floor(Math.random() * 100),
            replies: Math.floor(Math.random() * 50)
        });

        const sortedPosts = [...this.posts].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

        container.innerHTML = `
            <!-- Filters -->
            <div class="card mb-6">
                <div class="card-body">
                    <div class="flex gap-4 items-center flex-wrap">
                        <div class="form-group" style="margin: 0; min-width: 150px;">
                            <label class="form-label text-xs">Status</label>
                            <select class="form-select" id="filter-status" onchange="socialApp.filterPosts()">
                                <option value="">All Statuses</option>
                                <option value="posted">Posted</option>
                                <option value="pending">Pending</option>
                                <option value="draft">Draft</option>
                                <option value="failed">Failed</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin: 0; min-width: 150px;">
                            <label class="form-label text-xs">Platform</label>
                            <select class="form-select" id="filter-platform" onchange="socialApp.filterPosts()">
                                <option value="">All Platforms</option>
                                <option value="twitter">Twitter/X</option>
                                <option value="bluesky">Bluesky</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin: 0; min-width: 150px;">
                            <label class="form-label text-xs">From Date</label>
                            <input type="date" class="form-input" id="filter-date-from" onchange="socialApp.filterPosts()">
                        </div>
                        <div class="form-group" style="margin: 0; min-width: 150px;">
                            <label class="form-label text-xs">To Date</label>
                            <input type="date" class="form-input" id="filter-date-to" onchange="socialApp.filterPosts()">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Posts List -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">All Posts (${sortedPosts.length})</h3>
                </div>
                <div class="card-body" style="padding: 0;" id="posts-list">
                    ${sortedPosts.length === 0 ? `
                        <div class="empty-state">
                            <svg class="empty-state-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                            </svg>
                            <h3 class="empty-state-title">No posts yet</h3>
                            <p class="empty-state-description">Create your first post to get started!</p>
                            <button class="btn btn-primary" onclick="socialApp.switchTab('compose')">Create Post</button>
                        </div>
                    ` : sortedPosts.map(post => {
                        const engagement = mockEngagement();
                        return `
                            <div class="list-item" style="cursor: pointer;" onclick="socialApp.showPostDetail('${post.post_id}')">
                                <div class="list-item-content">
                                    <div class="list-item-title">${Utils.escapeHtml(Utils.truncate(post.content, 100))}</div>
                                    <div class="list-item-subtitle flex items-center gap-4 mt-2">
                                        <span>${Utils.formatRelativeTime(post.created_at)}</span>
                                        <span class="flex items-center gap-1">
                                            ${post.twitter_post_id ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>' : ''}
                                            ${post.bluesky_post_id ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 10.8c-1.087-2.114-4.046-6.053-6.798-7.995C2.566.944 1.561 1.266.902 1.565.139 1.908 0 3.08 0 3.768c0 .69.378 5.65.624 6.479.815 2.736 3.713 3.66 6.383 3.364.136-.02.275-.039.415-.056-.138.022-.276.04-.415.054-3.182.391-6.2-.655-6.383-3.364-.065-.237-.624-5.789-.624-6.479 0-.688.139-1.86.902-2.203.659-.299 1.664-.621 4.3 1.24 2.752 1.942 5.711 5.881 6.798 7.995z"/></svg>' : ''}
                                        </span>
                                        ${post.status === 'posted' ? `
                                            <span class="flex items-center gap-3 text-xs text-muted">
                                                <span title="Likes">${engagement.likes} likes</span>
                                                <span title="Retweets">${engagement.retweets} retweets</span>
                                                <span title="Replies">${engagement.replies} replies</span>
                                            </span>
                                        ` : ''}
                                    </div>
                                </div>
                                <span class="badge badge-${statusColors[post.status] || 'pending'}">${post.status}</span>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    },

    filterPosts() {
        const status = document.getElementById('filter-status').value;
        const platform = document.getElementById('filter-platform').value;
        const dateFrom = document.getElementById('filter-date-from').value;
        const dateTo = document.getElementById('filter-date-to').value;

        let filtered = [...this.posts];

        if (status) {
            filtered = filtered.filter(p => p.status === status);
        }

        if (platform === 'twitter') {
            filtered = filtered.filter(p => p.twitter_post_id);
        } else if (platform === 'bluesky') {
            filtered = filtered.filter(p => p.bluesky_post_id);
        }

        if (dateFrom) {
            filtered = filtered.filter(p => new Date(p.created_at) >= new Date(dateFrom));
        }

        if (dateTo) {
            filtered = filtered.filter(p => new Date(p.created_at) <= new Date(dateTo + 'T23:59:59'));
        }

        const statusColors = {
            posted: 'success',
            completed: 'success',
            draft: 'pending',
            failed: 'error',
            pending: 'warning',
            partial: 'warning'
        };

        const mockEngagement = () => ({
            likes: Math.floor(Math.random() * 500),
            retweets: Math.floor(Math.random() * 100),
            replies: Math.floor(Math.random() * 50)
        });

        const sortedPosts = filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        const container = document.getElementById('posts-list');

        container.innerHTML = sortedPosts.length === 0 ? `
            <div class="empty-state">
                <h3 class="empty-state-title">No posts match your filters</h3>
            </div>
        ` : sortedPosts.map(post => {
            const engagement = mockEngagement();
            return `
                <div class="list-item" style="cursor: pointer;" onclick="socialApp.showPostDetail('${post.post_id}')">
                    <div class="list-item-content">
                        <div class="list-item-title">${Utils.escapeHtml(Utils.truncate(post.content, 100))}</div>
                        <div class="list-item-subtitle flex items-center gap-4 mt-2">
                            <span>${Utils.formatRelativeTime(post.created_at)}</span>
                            <span class="flex items-center gap-1">
                                ${post.twitter_post_id ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>' : ''}
                                ${post.bluesky_post_id ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 10.8c-1.087-2.114-4.046-6.053-6.798-7.995C2.566.944 1.561 1.266.902 1.565.139 1.908 0 3.08 0 3.768c0 .69.378 5.65.624 6.479.815 2.736 3.713 3.66 6.383 3.364.136-.02.275-.039.415-.056-.138.022-.276.04-.415.054-3.182.391-6.2-.655-6.383-3.364-.065-.237-.624-5.789-.624-6.479 0-.688.139-1.86.902-2.203.659-.299 1.664-.621 4.3 1.24 2.752 1.942 5.711 5.881 6.798 7.995z"/></svg>' : ''}
                            </span>
                            ${post.status === 'posted' ? `
                                <span class="flex items-center gap-3 text-xs text-muted">
                                    <span>${engagement.likes} likes</span>
                                    <span>${engagement.retweets} retweets</span>
                                    <span>${engagement.replies} replies</span>
                                </span>
                            ` : ''}
                        </div>
                    </div>
                    <span class="badge badge-${statusColors[post.status] || 'pending'}">${post.status}</span>
                </div>
            `;
        }).join('');
    },

    showPostDetail(postId) {
        const post = this.posts.find(p => p.post_id === postId);
        if (!post) return;

        const statusColors = {
            posted: 'success',
            completed: 'success',
            draft: 'pending',
            failed: 'error',
            pending: 'warning',
            partial: 'warning'
        };

        const mockEngagement = {
            likes: Math.floor(Math.random() * 500) + 50,
            retweets: Math.floor(Math.random() * 100) + 10,
            replies: Math.floor(Math.random() * 50) + 5,
            impressions: Math.floor(Math.random() * 5000) + 500
        };

        window.app.modal.open({
            title: 'Post Details',
            content: `
                <div class="mb-6">
                    <label class="form-label">Content</label>
                    <div class="p-4" style="background: var(--color-background-secondary); border-radius: var(--radius-md); white-space: pre-wrap;">
                        ${Utils.escapeHtml(post.content)}
                    </div>
                </div>

                <div class="mb-6">
                    <label class="form-label">Status Timeline</label>
                    <div class="flex flex-col gap-2">
                        <div class="flex items-center gap-3">
                            <div class="avatar avatar-sm" style="background: var(--color-success);">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><polyline points="20,6 9,17 4,12"/></svg>
                            </div>
                            <div>
                                <div class="text-sm font-medium">Created</div>
                                <div class="text-xs text-muted">${Utils.formatDateTime(post.created_at)}</div>
                            </div>
                        </div>
                        ${post.status === 'posted' ? `
                            <div class="flex items-center gap-3">
                                <div class="avatar avatar-sm" style="background: var(--color-success);">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><polyline points="20,6 9,17 4,12"/></svg>
                                </div>
                                <div>
                                    <div class="text-sm font-medium">Posted</div>
                                    <div class="text-xs text-muted">${Utils.formatDateTime(post.created_at)}</div>
                                </div>
                            </div>
                        ` : post.status === 'failed' ? `
                            <div class="flex items-center gap-3">
                                <div class="avatar avatar-sm" style="background: var(--color-error);">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                                </div>
                                <div>
                                    <div class="text-sm font-medium text-error">Failed</div>
                                    <div class="text-xs text-muted">${post.error_message || 'Unknown error'}</div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>

                <div class="mb-6">
                    <label class="form-label">Platform Status</label>
                    <div class="grid grid-cols-2" style="gap: var(--space-3);">
                        <div class="p-3" style="background: var(--color-background-secondary); border-radius: var(--radius-md);">
                            <div class="flex items-center gap-2 mb-2">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                                </svg>
                                <span class="font-medium">Twitter/X</span>
                            </div>
                            <span class="badge badge-${post.twitter_post_id ? 'success' : 'pending'}">
                                ${post.twitter_post_id ? 'Posted' : 'Not posted'}
                            </span>
                        </div>
                        <div class="p-3" style="background: var(--color-background-secondary); border-radius: var(--radius-md);">
                            <div class="flex items-center gap-2 mb-2">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 10.8c-1.087-2.114-4.046-6.053-6.798-7.995C2.566.944 1.561 1.266.902 1.565.139 1.908 0 3.08 0 3.768c0 .69.378 5.65.624 6.479.815 2.736 3.713 3.66 6.383 3.364.136-.02.275-.039.415-.056-.138.022-.276.04-.415.054-3.182.391-6.2-.655-6.383-3.364-.065-.237-.624-5.789-.624-6.479 0-.688.139-1.86.902-2.203.659-.299 1.664-.621 4.3 1.24 2.752 1.942 5.711 5.881 6.798 7.995z"/>
                                </svg>
                                <span class="font-medium">Bluesky</span>
                            </div>
                            <span class="badge badge-${post.bluesky_post_id ? 'success' : 'pending'}">
                                ${post.bluesky_post_id ? 'Posted' : 'Not posted'}
                            </span>
                        </div>
                    </div>
                </div>

                ${post.status === 'posted' ? `
                    <div class="mb-6">
                        <label class="form-label">Engagement (Mock Data)</label>
                        <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
                            <div class="text-center p-3" style="background: var(--color-background-secondary); border-radius: var(--radius-md);">
                                <div class="font-semibold">${mockEngagement.impressions}</div>
                                <div class="text-xs text-muted">Impressions</div>
                            </div>
                            <div class="text-center p-3" style="background: var(--color-background-secondary); border-radius: var(--radius-md);">
                                <div class="font-semibold">${mockEngagement.likes}</div>
                                <div class="text-xs text-muted">Likes</div>
                            </div>
                            <div class="text-center p-3" style="background: var(--color-background-secondary); border-radius: var(--radius-md);">
                                <div class="font-semibold">${mockEngagement.retweets}</div>
                                <div class="text-xs text-muted">Retweets</div>
                            </div>
                            <div class="text-center p-3" style="background: var(--color-background-secondary); border-radius: var(--radius-md);">
                                <div class="font-semibold">${mockEngagement.replies}</div>
                                <div class="text-xs text-muted">Replies</div>
                            </div>
                        </div>
                    </div>
                ` : ''}
            `,
            footer: `
                ${post.status === 'failed' ? `<button class="btn btn-primary" onclick="socialApp.retryPost('${post.post_id}')">Retry</button>` : ''}
                ${post.status === 'pending' || post.status === 'draft' ? `<button class="btn btn-secondary" onclick="socialApp.editPost('${post.post_id}')">Edit</button>` : ''}
                <button class="btn btn-danger" onclick="socialApp.deletePost('${post.post_id}')">Delete</button>
                <button class="btn btn-secondary" onclick="window.app.modal.close()">Close</button>
            `
        });
    },

    async retryPost(postId) {
        try {
            await window.app.api.publishSocialPost(postId);
            window.app.toast.success('Post retry initiated');
            window.app.modal.close();
            await this.init();
        } catch (error) {
            window.app.toast.error('Failed to retry post');
        }
    },

    editPost(postId) {
        const post = this.posts.find(p => p.post_id === postId);
        if (!post) return;

        window.app.modal.close();
        this.switchTab('compose');

        setTimeout(() => {
            document.getElementById('compose-content').value = post.content;
            this.updateCharCount();
        }, 100);
    },

    async deletePost(postId) {
        const confirmed = await window.app.modal.confirm(
            'Are you sure you want to delete this post?',
            { title: 'Delete Post', type: 'danger', confirmText: 'Delete' }
        );

        if (confirmed) {
            // Mock deletion
            this.posts = this.posts.filter(p => p.post_id !== postId);
            window.app.toast.success('Post deleted');
            this.renderTab(this.currentTab);
        }
    },

    // ==========================================
    // SCHEDULED QUEUE SECTION
    // ==========================================
    renderScheduled(container) {
        const scheduledPosts = this.posts.filter(p => p.status === 'pending');

        // Group by date for calendar view
        const grouped = {};
        scheduledPosts.forEach(post => {
            const date = new Date(post.created_at).toDateString();
            if (!grouped[date]) grouped[date] = [];
            grouped[date].push(post);
        });

        container.innerHTML = `
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: var(--space-6);">
                <!-- Calendar View -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Calendar View</h3>
                        <div class="flex gap-2">
                            <button class="btn btn-ghost btn-sm" onclick="socialApp.prevMonth()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
                            </button>
                            <span id="calendar-month" class="font-medium">${new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</span>
                            <button class="btn btn-ghost btn-sm" onclick="socialApp.nextMonth()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: var(--space-1);">
                            ${this.renderCalendar(new Date(), scheduledPosts)}
                        </div>
                    </div>
                </div>

                <!-- List View -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Scheduled Posts (${scheduledPosts.length})</h3>
                    </div>
                    <div class="card-body" style="padding: 0; max-height: 500px; overflow-y: auto;">
                        ${scheduledPosts.length === 0 ? `
                            <div class="empty-state">
                                <svg class="empty-state-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <polyline points="12,6 12,12 16,14"/>
                                </svg>
                                <h3 class="empty-state-title">No scheduled posts</h3>
                                <p class="empty-state-description">Schedule posts to see them here</p>
                            </div>
                        ` : scheduledPosts.map(post => `
                            <div class="list-item" draggable="true" ondragstart="socialApp.dragStart(event, '${post.post_id}')" style="cursor: move;">
                                <div class="list-item-content">
                                    <div class="list-item-title">${Utils.escapeHtml(Utils.truncate(post.content, 60))}</div>
                                    <div class="list-item-subtitle">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline;">
                                            <circle cx="12" cy="12" r="10"/>
                                            <polyline points="12,6 12,12 16,14"/>
                                        </svg>
                                        ${Utils.formatDateTime(post.created_at)}
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button class="btn btn-ghost btn-sm" onclick="socialApp.quickEditSchedule('${post.post_id}')" title="Edit schedule">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"/>
                                            <polyline points="12,6 12,12 16,14"/>
                                        </svg>
                                    </button>
                                    <button class="btn btn-ghost btn-sm" onclick="socialApp.editPost('${post.post_id}')" title="Edit content">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    },

    renderCalendar(date, posts) {
        const year = date.getFullYear();
        const month = date.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const today = new Date();

        let html = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']
            .map(d => `<div class="text-center text-xs text-muted p-2">${d}</div>`).join('');

        for (let i = 0; i < firstDay; i++) {
            html += '<div></div>';
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = new Date(year, month, day).toDateString();
            const dayPosts = posts.filter(p => new Date(p.created_at).toDateString() === dateStr);
            const isToday = today.toDateString() === dateStr;

            html += `
                <div class="text-center p-2" style="
                    background: ${isToday ? 'var(--color-accent-light)' : dayPosts.length ? 'var(--color-success-bg)' : 'transparent'};
                    border-radius: var(--radius-md);
                    cursor: ${dayPosts.length ? 'pointer' : 'default'};
                " ${dayPosts.length ? `onclick="socialApp.showDayPosts('${dateStr}')"` : ''}>
                    <div class="text-sm ${isToday ? 'font-semibold' : ''}">${day}</div>
                    ${dayPosts.length ? `<div class="text-xs text-success">${dayPosts.length} post${dayPosts.length > 1 ? 's' : ''}</div>` : ''}
                </div>
            `;
        }

        return html;
    },

    showDayPosts(dateStr) {
        const dayPosts = this.posts.filter(p => new Date(p.created_at).toDateString() === dateStr);

        window.app.modal.open({
            title: `Posts for ${new Date(dateStr).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}`,
            content: dayPosts.map(post => `
                <div class="list-item">
                    <div class="list-item-content">
                        <div class="list-item-title">${Utils.escapeHtml(Utils.truncate(post.content, 80))}</div>
                        <div class="list-item-subtitle">${Utils.formatDateTime(post.created_at)}</div>
                    </div>
                    <span class="badge badge-${post.status === 'posted' ? 'success' : 'warning'}">${post.status}</span>
                </div>
            `).join(''),
            footer: '<button class="btn btn-secondary" onclick="window.app.modal.close()">Close</button>'
        });
    },

    quickEditSchedule(postId) {
        const post = this.posts.find(p => p.post_id === postId);
        if (!post) return;

        const date = new Date(post.created_at);

        window.app.modal.open({
            title: 'Reschedule Post',
            content: `
                <div class="grid grid-cols-2" style="gap: var(--space-3);">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" id="reschedule-date" value="${date.toISOString().split('T')[0]}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Time</label>
                        <input type="time" class="form-input" id="reschedule-time" value="${date.toTimeString().slice(0, 5)}">
                    </div>
                </div>
                <div class="mt-4 p-3" style="background: var(--color-background-secondary); border-radius: var(--radius-md);">
                    <div class="text-sm text-muted">${Utils.escapeHtml(Utils.truncate(post.content, 100))}</div>
                </div>
            `,
            footer: `
                <button class="btn btn-secondary" onclick="window.app.modal.close()">Cancel</button>
                <button class="btn btn-primary" onclick="socialApp.saveReschedule('${postId}')">Save</button>
            `
        });
    },

    saveReschedule(postId) {
        const date = document.getElementById('reschedule-date').value;
        const time = document.getElementById('reschedule-time').value;

        const post = this.posts.find(p => p.post_id === postId);
        if (post) {
            post.created_at = new Date(`${date}T${time}`).toISOString();
        }

        window.app.modal.close();
        window.app.toast.success('Post rescheduled');
        this.renderScheduled(document.getElementById('social-content'));
    },

    dragStart(event, postId) {
        event.dataTransfer.setData('text/plain', postId);
    },

    // ==========================================
    // DRAFTS SECTION
    // ==========================================
    renderDrafts(container) {
        const drafts = JSON.parse(localStorage.getItem('social_drafts') || '[]');

        container.innerHTML = `
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Drafts (${drafts.length})</h3>
                </div>
                <div class="card-body" style="padding: 0;">
                    ${drafts.length === 0 ? `
                        <div class="empty-state">
                            <svg class="empty-state-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14,2 14,8 20,8"/>
                            </svg>
                            <h3 class="empty-state-title">No drafts</h3>
                            <p class="empty-state-description">Save drafts while composing to see them here</p>
                        </div>
                    ` : drafts.map(draft => `
                        <div class="list-item">
                            <div class="list-item-content">
                                <div class="list-item-title">${Utils.escapeHtml(Utils.truncate(draft.content, 100))}</div>
                                <div class="list-item-subtitle">
                                    Saved ${Utils.formatRelativeTime(draft.created_at)}
                                    ${draft.platforms?.twitter ? ' - Twitter' : ''}
                                    ${draft.platforms?.bluesky ? ' - Bluesky' : ''}
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button class="btn btn-primary btn-sm" onclick="socialApp.loadDraft('${draft.id}')">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                    </svg>
                                    Edit
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="socialApp.deleteDraft('${draft.id}')">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3,6 5,6 21,6"/>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    },

    loadDraft(draftId) {
        const drafts = JSON.parse(localStorage.getItem('social_drafts') || '[]');
        const draft = drafts.find(d => d.id === draftId);
        if (!draft) return;

        this.switchTab('compose');
        setTimeout(() => {
            document.getElementById('compose-content').value = draft.content;
            document.getElementById('platform-twitter').checked = draft.platforms?.twitter ?? true;
            document.getElementById('platform-bluesky').checked = draft.platforms?.bluesky ?? true;
            this.updateCharCount();
        }, 100);
    },

    deleteDraft(draftId) {
        let drafts = JSON.parse(localStorage.getItem('social_drafts') || '[]');
        drafts = drafts.filter(d => d.id !== draftId);
        localStorage.setItem('social_drafts', JSON.stringify(drafts));
        window.app.toast.success('Draft deleted');
        this.renderDrafts(document.getElementById('social-content'));
    },

    // ==========================================
    // ANALYTICS SECTION
    // ==========================================
    renderAnalytics(container) {
        const postedPosts = this.posts.filter(p => p.status === 'posted');
        const twitterPosts = this.posts.filter(p => p.twitter_post_id);
        const blueskyPosts = this.posts.filter(p => p.bluesky_post_id);
        const failedPosts = this.posts.filter(p => p.status === 'failed');

        const successRate = this.posts.length > 0
            ? ((postedPosts.length / this.posts.length) * 100).toFixed(1)
            : 0;

        // Mock best posting times
        const bestTimes = [
            { time: '9:00 AM', engagement: 85 },
            { time: '12:00 PM', engagement: 72 },
            { time: '3:00 PM', engagement: 68 },
            { time: '6:00 PM', engagement: 91 },
            { time: '9:00 PM', engagement: 78 }
        ];

        // Mock engagement trend data
        const trendData = [
            { week: 'Week 1', engagement: 450 },
            { week: 'Week 2', engagement: 520 },
            { week: 'Week 3', engagement: 480 },
            { week: 'Week 4', engagement: 650 }
        ];

        container.innerHTML = `
            <!-- Stats Overview -->
            <div class="stats-grid mb-6">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <span class="stat-card-title">Total Posts</span>
                        <svg class="stat-card-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                        </svg>
                    </div>
                    <div class="stat-card-value">${this.posts.length}</div>
                    <div class="stat-card-change positive">All time</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <span class="stat-card-title">Success Rate</span>
                        <svg class="stat-card-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22,4 12,14.01 9,11.01"/>
                        </svg>
                    </div>
                    <div class="stat-card-value">${successRate}%</div>
                    <div class="stat-card-change ${parseFloat(successRate) >= 90 ? 'positive' : 'negative'}">
                        ${postedPosts.length} posted, ${failedPosts.length} failed
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <span class="stat-card-title">Twitter Posts</span>
                        <svg class="stat-card-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                        </svg>
                    </div>
                    <div class="stat-card-value">${twitterPosts.length}</div>
                    <div class="stat-card-change positive">Posted to Twitter/X</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <span class="stat-card-title">Bluesky Posts</span>
                        <svg class="stat-card-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 10.8c-1.087-2.114-4.046-6.053-6.798-7.995C2.566.944 1.561 1.266.902 1.565.139 1.908 0 3.08 0 3.768c0 .69.378 5.65.624 6.479.815 2.736 3.713 3.66 6.383 3.364.136-.02.275-.039.415-.056-.138.022-.276.04-.415.054-3.182.391-6.2-.655-6.383-3.364-.065-.237-.624-5.789-.624-6.479 0-.688.139-1.86.902-2.203.659-.299 1.664-.621 4.3 1.24 2.752 1.942 5.711 5.881 6.798 7.995z"/>
                        </svg>
                    </div>
                    <div class="stat-card-value">${blueskyPosts.length}</div>
                    <div class="stat-card-change positive">Posted to Bluesky</div>
                </div>
            </div>

            <div class="grid grid-cols-2 mb-6">
                <!-- Best Posting Times -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Best Posting Times</h3>
                    </div>
                    <div class="card-body">
                        ${bestTimes.map(t => `
                            <div class="flex items-center gap-4 mb-3">
                                <span class="text-sm" style="width: 80px;">${t.time}</span>
                                <div style="flex: 1; height: 24px; background: var(--color-background-secondary); border-radius: var(--radius-sm); overflow: hidden;">
                                    <div style="width: ${t.engagement}%; height: 100%; background: var(--color-accent); transition: width 0.5s ease;"></div>
                                </div>
                                <span class="text-sm text-muted">${t.engagement}%</span>
                            </div>
                        `).join('')}
                        <p class="text-xs text-muted mt-4">Based on historical engagement data (mock)</p>
                    </div>
                </div>

                <!-- Engagement Trend -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Engagement Trend</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; align-items: flex-end; height: 200px; gap: var(--space-4);">
                            ${trendData.map(d => {
                                const maxEngagement = Math.max(...trendData.map(t => t.engagement));
                                const height = (d.engagement / maxEngagement) * 100;
                                return `
                                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                                        <div class="text-xs mb-2">${d.engagement}</div>
                                        <div style="width: 100%; height: ${height}%; background: var(--color-accent); border-radius: var(--radius-sm) var(--radius-sm) 0 0; min-height: 20px;"></div>
                                        <div class="text-xs text-muted mt-2">${d.week}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <p class="text-xs text-muted mt-4">Total engagement per week (mock data)</p>
                    </div>
                </div>
            </div>

            <!-- Platform Breakdown -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Platform Performance</h3>
                </div>
                <div class="card-body">
                    <div class="grid grid-cols-2" style="gap: var(--space-6);">
                        <div>
                            <div class="flex items-center gap-3 mb-4">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                                </svg>
                                <span class="font-semibold">Twitter/X</span>
                            </div>
                            <div class="grid grid-cols-2" style="gap: var(--space-3);">
                                <div class="p-3" style="background: var(--color-background-secondary); border-radius: var(--radius-md);">
                                    <div class="text-2xl font-semibold">${Math.floor(Math.random() * 5000 + 1000)}</div>
                                    <div class="text-xs text-muted">Total Impressions</div>
                                </div>
                                <div class="p-3" style="background: var(--color-background-secondary); border-radius: var(--radius-md);">
                                    <div class="text-2xl font-semibold">${Math.floor(Math.random() * 500 + 100)}</div>
                                    <div class="text-xs text-muted">Total Engagements</div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center gap-3 mb-4">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 10.8c-1.087-2.114-4.046-6.053-6.798-7.995C2.566.944 1.561 1.266.902 1.565.139 1.908 0 3.08 0 3.768c0 .69.378 5.65.624 6.479.815 2.736 3.713 3.66 6.383 3.364.136-.02.275-.039.415-.056-.138.022-.276.04-.415.054-3.182.391-6.2-.655-6.383-3.364-.065-.237-.624-5.789-.624-6.479 0-.688.139-1.86.902-2.203.659-.299 1.664-.621 4.3 1.24 2.752 1.942 5.711 5.881 6.798 7.995z"/>
                                </svg>
                                <span class="font-semibold">Bluesky</span>
                            </div>
                            <div class="grid grid-cols-2" style="gap: var(--space-3);">
                                <div class="p-3" style="background: var(--color-background-secondary); border-radius: var(--radius-md);">
                                    <div class="text-2xl font-semibold">${Math.floor(Math.random() * 3000 + 500)}</div>
                                    <div class="text-xs text-muted">Total Impressions</div>
                                </div>
                                <div class="p-3" style="background: var(--color-background-secondary); border-radius: var(--radius-md);">
                                    <div class="text-2xl font-semibold">${Math.floor(Math.random() * 300 + 50)}</div>
                                    <div class="text-xs text-muted">Total Engagements</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },

    // ==========================================
    // CREDENTIALS SECTION
    // ==========================================
    renderCredentials(container) {
        const twitter = this.credentials?.twitter || {};
        const bluesky = this.credentials?.bluesky || {};

        container.innerHTML = `
            <div class="grid grid-cols-2 mb-6">
                <!-- Twitter Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="flex items-center gap-3">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                            </svg>
                            <h3 class="card-title">Twitter/X</h3>
                        </div>
                        <span class="badge badge-${twitter.working ? 'success' : 'error'}">
                            ${twitter.working ? 'Connected' : 'Disconnected'}
                        </span>
                    </div>
                    <div class="card-body">
                        ${twitter.working ? `
                            <div class="flex items-center gap-4 mb-4">
                                <div class="avatar" style="background-color: hsl(200, 50%, 50%);">
                                    ${twitter.profile?.username?.charAt(0)?.toUpperCase() || 'U'}
                                </div>
                                <div>
                                    <div class="font-semibold">${twitter.profile?.displayName || 'User'}</div>
                                    <div class="text-sm text-muted">@${twitter.profile?.username || 'username'}</div>
                                </div>
                            </div>
                            <div class="mb-4">
                                <div class="flex justify-between text-sm mb-2">
                                    <span class="text-muted">Connection Health</span>
                                    <span class="text-success">Good</span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar" style="width: 100%; background: var(--color-success);"></div>
                                </div>
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="socialApp.checkCredentialHealth('twitter')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="23,4 23,10 17,10"/>
                                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                                </svg>
                                Check Health
                            </button>
                            <button class="btn btn-danger btn-sm ml-2" onclick="socialApp.disconnectPlatform('twitter')">Disconnect</button>
                        ` : `
                            <p class="text-muted mb-4">Connect your Twitter/X account to post directly from Garden.</p>
                            <button class="btn btn-primary" onclick="socialApp.connectPlatform('twitter')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                                </svg>
                                Connect Twitter/X
                            </button>
                        `}
                    </div>
                </div>

                <!-- Bluesky Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="flex items-center gap-3">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 10.8c-1.087-2.114-4.046-6.053-6.798-7.995C2.566.944 1.561 1.266.902 1.565.139 1.908 0 3.08 0 3.768c0 .69.378 5.65.624 6.479.815 2.736 3.713 3.66 6.383 3.364.136-.02.275-.039.415-.056-.138.022-.276.04-.415.054-3.182.391-6.2-.655-6.383-3.364-.065-.237-.624-5.789-.624-6.479 0-.688.139-1.86.902-2.203.659-.299 1.664-.621 4.3 1.24 2.752 1.942 5.711 5.881 6.798 7.995z"/>
                            </svg>
                            <h3 class="card-title">Bluesky</h3>
                        </div>
                        <span class="badge badge-${bluesky.working ? 'success' : 'error'}">
                            ${bluesky.working ? 'Connected' : 'Disconnected'}
                        </span>
                    </div>
                    <div class="card-body">
                        ${bluesky.working ? `
                            <div class="flex items-center gap-4 mb-4">
                                <div class="avatar" style="background-color: hsl(210, 50%, 50%);">
                                    ${bluesky.profile?.handle?.charAt(0)?.toUpperCase() || 'U'}
                                </div>
                                <div>
                                    <div class="font-semibold">${bluesky.profile?.displayName || 'User'}</div>
                                    <div class="text-sm text-muted">@${bluesky.profile?.handle || 'handle.bsky.social'}</div>
                                </div>
                            </div>
                            <div class="mb-4">
                                <div class="flex justify-between text-sm mb-2">
                                    <span class="text-muted">Connection Health</span>
                                    <span class="text-success">Good</span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar" style="width: 100%; background: var(--color-success);"></div>
                                </div>
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="socialApp.checkCredentialHealth('bluesky')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="23,4 23,10 17,10"/>
                                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                                </svg>
                                Check Health
                            </button>
                            <button class="btn btn-danger btn-sm ml-2" onclick="socialApp.disconnectPlatform('bluesky')">Disconnect</button>
                        ` : `
                            <p class="text-muted mb-4">Connect your Bluesky account to cross-post content.</p>
                            <button class="btn btn-primary" onclick="socialApp.connectPlatform('bluesky')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                                </svg>
                                Connect Bluesky
                            </button>
                        `}
                    </div>
                </div>
            </div>

            <!-- API Status -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">API Status</h3>
                </div>
                <div class="card-body">
                    <div class="grid grid-cols-3" style="gap: var(--space-4);">
                        <div class="p-4" style="background: var(--color-success-bg); border-radius: var(--radius-md); text-align: center;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--color-success)" stroke-width="2" style="margin: 0 auto var(--space-2);">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                <polyline points="22,4 12,14.01 9,11.01"/>
                            </svg>
                            <div class="font-semibold text-success">Twitter API</div>
                            <div class="text-xs text-muted">Operational</div>
                        </div>
                        <div class="p-4" style="background: var(--color-success-bg); border-radius: var(--radius-md); text-align: center;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--color-success)" stroke-width="2" style="margin: 0 auto var(--space-2);">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                <polyline points="22,4 12,14.01 9,11.01"/>
                            </svg>
                            <div class="font-semibold text-success">Bluesky API</div>
                            <div class="text-xs text-muted">Operational</div>
                        </div>
                        <div class="p-4" style="background: var(--color-success-bg); border-radius: var(--radius-md); text-align: center;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--color-success)" stroke-width="2" style="margin: 0 auto var(--space-2);">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                <polyline points="22,4 12,14.01 9,11.01"/>
                            </svg>
                            <div class="font-semibold text-success">Garden Backend</div>
                            <div class="text-xs text-muted">Operational</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },

    connectPlatform(platform) {
        window.app.modal.open({
            title: `Connect ${platform === 'twitter' ? 'Twitter/X' : 'Bluesky'}`,
            content: platform === 'twitter' ? `
                <div class="text-center mb-6">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor" style="margin: 0 auto var(--space-4);">
                        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                    </svg>
                    <p class="text-muted">You will be redirected to Twitter to authorize Garden.</p>
                </div>
                <div class="p-4" style="background: var(--color-background-secondary); border-radius: var(--radius-md);">
                    <div class="text-sm font-medium mb-2">Permissions requested:</div>
                    <ul class="text-sm text-muted" style="list-style: disc; padding-left: var(--space-5);">
                        <li>Post tweets on your behalf</li>
                        <li>Read your profile information</li>
                    </ul>
                </div>
            ` : `
                <div class="form-group">
                    <label class="form-label">Handle</label>
                    <input type="text" class="form-input" id="bluesky-handle" placeholder="username.bsky.social">
                </div>
                <div class="form-group">
                    <label class="form-label">App Password</label>
                    <input type="password" class="form-input" id="bluesky-password" placeholder="xxxx-xxxx-xxxx-xxxx">
                    <p class="form-helper">Create an app password at <a href="https://bsky.app/settings/app-passwords" target="_blank">bsky.app/settings/app-passwords</a></p>
                </div>
            `,
            footer: `
                <button class="btn btn-secondary" onclick="window.app.modal.close()">Cancel</button>
                <button class="btn btn-primary" onclick="socialApp.finishConnect('${platform}')">${platform === 'twitter' ? 'Authorize with Twitter' : 'Connect'}</button>
            `
        });
    },

    async finishConnect(platform) {
        if (platform === 'twitter') {
            // Mock OAuth flow
            window.app.toast.info('Redirecting to Twitter... (Mock)');
            await new Promise(r => setTimeout(r, 1500));

            if (this.credentials) {
                this.credentials.twitter = {
                    working: true,
                    profile: {
                        username: 'gardenuser',
                        displayName: 'Garden User'
                    }
                };
            }
        } else {
            const handle = document.getElementById('bluesky-handle').value;
            const password = document.getElementById('bluesky-password').value;

            if (!handle || !password) {
                window.app.toast.warning('Please fill in all fields');
                return;
            }

            if (this.credentials) {
                this.credentials.bluesky = {
                    working: true,
                    profile: {
                        handle: handle,
                        displayName: handle.split('.')[0]
                    }
                };
            }
        }

        window.app.modal.close();
        window.app.toast.success(`${platform === 'twitter' ? 'Twitter/X' : 'Bluesky'} connected successfully!`);
        this.renderCredentials(document.getElementById('social-content'));
    },

    async disconnectPlatform(platform) {
        const confirmed = await window.app.modal.confirm(
            `Are you sure you want to disconnect ${platform === 'twitter' ? 'Twitter/X' : 'Bluesky'}?`,
            { title: 'Disconnect Account', type: 'danger', confirmText: 'Disconnect' }
        );

        if (confirmed && this.credentials) {
            this.credentials[platform] = { working: false };
            window.app.toast.success('Account disconnected');
            this.renderCredentials(document.getElementById('social-content'));
        }
    },

    checkCredentialHealth(platform) {
        window.app.toast.info(`Checking ${platform} connection...`);
        setTimeout(() => {
            window.app.toast.success(`${platform === 'twitter' ? 'Twitter/X' : 'Bluesky'} connection is healthy!`);
        }, 1000);
    },

    // ==========================================
    // TEMPLATES SECTION
    // ==========================================
    renderTemplates(container) {
        container.innerHTML = `
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Post Templates (${this.templates.length})</h3>
                    <button class="btn btn-primary btn-sm" onclick="socialApp.createTemplate()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        New Template
                    </button>
                </div>
                <div class="card-body" style="padding: 0;">
                    ${this.templates.length === 0 ? `
                        <div class="empty-state">
                            <svg class="empty-state-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14,2 14,8 20,8"/>
                            </svg>
                            <h3 class="empty-state-title">No templates</h3>
                            <p class="empty-state-description">Create templates for frequently used post formats</p>
                        </div>
                    ` : this.templates.map(template => `
                        <div class="list-item">
                            <div class="list-item-content">
                                <div class="list-item-title">${Utils.escapeHtml(template.name)}</div>
                                <div class="list-item-subtitle">${Utils.escapeHtml(Utils.truncate(template.content, 80))}</div>
                            </div>
                            <div class="flex gap-2">
                                <button class="btn btn-primary btn-sm" onclick="socialApp.useTemplate('${template.id}')">
                                    Use
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="socialApp.editTemplate('${template.id}')">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                    </svg>
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="socialApp.deleteTemplate('${template.id}')">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3,6 5,6 21,6"/>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    },

    createTemplate() {
        window.app.modal.open({
            title: 'Create Template',
            content: `
                <div class="form-group">
                    <label class="form-label">Template Name</label>
                    <input type="text" class="form-input" id="template-name" placeholder="e.g., Product Announcement">
                </div>
                <div class="form-group">
                    <label class="form-label">Content</label>
                    <textarea class="form-textarea" id="template-content" rows="5" placeholder="Enter template content. Use [placeholders] for dynamic content."></textarea>
                    <p class="form-helper">Use [placeholders] like [title], [link], [date] for dynamic content</p>
                </div>
            `,
            footer: `
                <button class="btn btn-secondary" onclick="window.app.modal.close()">Cancel</button>
                <button class="btn btn-primary" onclick="socialApp.saveNewTemplate()">Save Template</button>
            `
        });
    },

    saveNewTemplate() {
        const name = document.getElementById('template-name').value.trim();
        const content = document.getElementById('template-content').value.trim();

        if (!name || !content) {
            window.app.toast.warning('Please fill in all fields');
            return;
        }

        this.templates.push({
            id: 't' + Date.now(),
            name,
            content
        });
        this.saveTemplates();
        window.app.modal.close();
        window.app.toast.success('Template created');
        this.renderTemplates(document.getElementById('social-content'));
    },

    useTemplate(templateId) {
        const template = this.templates.find(t => t.id === templateId);
        if (!template) return;

        this.switchTab('compose');
        setTimeout(() => {
            document.getElementById('compose-content').value = template.content;
            this.updateCharCount();
        }, 100);
    },

    editTemplate(templateId) {
        const template = this.templates.find(t => t.id === templateId);
        if (!template) return;

        window.app.modal.open({
            title: 'Edit Template',
            content: `
                <div class="form-group">
                    <label class="form-label">Template Name</label>
                    <input type="text" class="form-input" id="template-name" value="${Utils.escapeHtml(template.name)}">
                </div>
                <div class="form-group">
                    <label class="form-label">Content</label>
                    <textarea class="form-textarea" id="template-content" rows="5">${Utils.escapeHtml(template.content)}</textarea>
                </div>
            `,
            footer: `
                <button class="btn btn-secondary" onclick="window.app.modal.close()">Cancel</button>
                <button class="btn btn-primary" onclick="socialApp.updateTemplate('${templateId}')">Save Changes</button>
            `
        });
    },

    updateTemplate(templateId) {
        const template = this.templates.find(t => t.id === templateId);
        if (!template) return;

        template.name = document.getElementById('template-name').value.trim();
        template.content = document.getElementById('template-content').value.trim();

        this.saveTemplates();
        window.app.modal.close();
        window.app.toast.success('Template updated');
        this.renderTemplates(document.getElementById('social-content'));
    },

    deleteTemplate(templateId) {
        this.templates = this.templates.filter(t => t.id !== templateId);
        this.saveTemplates();
        window.app.toast.success('Template deleted');
        this.renderTemplates(document.getElementById('social-content'));
    }
};

// Initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => socialApp.init());
} else {
    socialApp.init();
}
</script>
